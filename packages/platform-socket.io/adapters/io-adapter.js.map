{"version":3,"file":"io-adapter.js","sourceRoot":"","sources":["io-adapter.ts"],"names":[],"mappings":";;;AAAA,oEAAsE;AACtE,mDAG4B;AAC5B,4DAAgE;AAChE,+BAA6C;AAC7C,8CAAgF;AAChF,yCAA0D;AAE1D;;GAEG;AACH,MAAa,SAAU,SAAQ,8BAAiB;IACvC,MAAM,CACX,IAAY,EACZ,OAA8D;QAE9D,IAAI,CAAC,OAAO,EAAE;YACZ,OAAO,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC;SAClC;QACD,MAAM,EAAE,SAAS,EAAE,MAAM,EAAE,GAAG,GAAG,EAAE,GAAG,OAAO,CAAC;QAC9C,OAAO,MAAM,IAAI,IAAA,yBAAU,EAAC,MAAM,CAAC,EAAE,CAAC;YACpC,CAAC,CAAC,MAAM,CAAC,EAAE,CAAC,SAAS,CAAC;YACtB,CAAC,CAAC,SAAS;gBACX,CAAC,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,EAAE,GAAG,CAAC,CAAC,EAAE,CAAC,SAAS,CAAC;gBAC9C,CAAC,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,EAAE,GAAG,CAAC,CAAC;IACrC,CAAC;IAEM,cAAc,CAAC,IAAY,EAAE,OAAa;QAC/C,IAAI,IAAI,CAAC,UAAU,IAAI,IAAI,KAAK,CAAC,EAAE;YACjC,OAAO,IAAI,kBAAM,CAAC,IAAI,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC;SAC7C;QACD,OAAO,IAAI,kBAAM,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;IACnC,CAAC;IAEM,mBAAmB,CACxB,MAAc,EACd,QAAoC,EACpC,SAAyC;QAEzC,MAAM,WAAW,GAAG,IAAA,gBAAS,EAAC,MAAM,EAAE,4BAAgB,CAAC,CAAC,IAAI,CAC1D,IAAA,iBAAK,GAAE,EACP,IAAA,iBAAK,GAAE,CACR,CAAC;QAEF,QAAQ,CAAC,OAAO,CAAC,CAAC,EAAE,OAAO,EAAE,QAAQ,EAAE,EAAE,EAAE;YACzC,MAAM,OAAO,GAAG,IAAA,gBAAS,EAAC,MAAM,EAAE,OAAO,CAAC,CAAC,IAAI,CAC7C,IAAA,oBAAQ,EAAC,CAAC,OAAY,EAAE,EAAE;gBACxB,MAAM,EAAE,IAAI,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC;gBAC/C,OAAO,SAAS,CAAC,QAAQ,CAAC,IAAI,EAAE,GAAG,CAAC,CAAC,CAAC,IAAI,CACxC,IAAA,kBAAM,EAAC,CAAC,QAAa,EAAE,EAAE,CAAC,CAAC,IAAA,oBAAK,EAAC,QAAQ,CAAC,CAAC,EAC3C,IAAA,eAAG,EAAC,CAAC,QAAa,EAAE,EAAE,CAAC,CAAC,QAAQ,EAAE,GAAG,CAAC,CAAC,CACxC,CAAC;YACJ,CAAC,CAAC,EACF,IAAA,qBAAS,EAAC,WAAW,CAAC,CACvB,CAAC;YACF,OAAO,CAAC,SAAS,CAAC,CAAC,CAAC,QAAQ,EAAE,GAAG,CAAC,EAAE,EAAE;gBACpC,IAAI,QAAQ,CAAC,KAAK,EAAE;oBAClB,OAAO,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,QAAQ,CAAC,IAAI,CAAC,CAAC;iBACnD;gBACD,IAAA,yBAAU,EAAC,GAAG,CAAC,IAAI,GAAG,CAAC,QAAQ,CAAC,CAAC;YACnC,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC;IAEM,UAAU,CAAC,OAAgB;QAChC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,EAAE;YAC3B,IAAI,IAAA,yBAAU,EAAC,OAAO,CAAC,EAAE;gBACvB,OAAO,EAAE,IAAI,EAAE,SAAS,EAAE,GAAG,EAAE,OAAmB,EAAE,CAAC;aACtD;YACD,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC;SAC1B;QACD,MAAM,WAAW,GAAG,OAAO,CAAC,OAAO,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;QAChD,MAAM,KAAK,GAAG,IAAA,yBAAU,EAAC,WAAW,CAAC,CAAC;QACtC,IAAI,KAAK,EAAE;YACT,MAAM,IAAI,GAAG,OAAO,CAAC,MAAM,GAAG,CAAC,CAAC;YAChC,OAAO;gBACL,IAAI,EAAE,IAAI,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,EAAE,IAAI,CAAC;gBACtD,GAAG,EAAE,WAAW;aACjB,CAAC;SACH;QACD,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC;IAC3B,CAAC;CACF;AAvED,8BAuEC","sourcesContent":["import { isFunction, isNil } from '@nestjs/common/utils/shared.utils';\r\nimport {\r\n  AbstractWsAdapter,\r\n  MessageMappingProperties,\r\n} from '@nestjs/websockets';\r\nimport { DISCONNECT_EVENT } from '@nestjs/websockets/constants';\r\nimport { fromEvent, Observable } from 'rxjs';\r\nimport { filter, first, map, mergeMap, share, takeUntil } from 'rxjs/operators';\r\nimport { Server, ServerOptions, Socket } from 'socket.io';\r\n\r\n/**\r\n * @publicApi\r\n */\r\nexport class IoAdapter extends AbstractWsAdapter {\r\n  public create(\r\n    port: number,\r\n    options?: ServerOptions & { namespace?: string; server?: any },\r\n  ): Server {\r\n    if (!options) {\r\n      return this.createIOServer(port);\r\n    }\r\n    const { namespace, server, ...opt } = options;\r\n    return server && isFunction(server.of)\r\n      ? server.of(namespace)\r\n      : namespace\r\n      ? this.createIOServer(port, opt).of(namespace)\r\n      : this.createIOServer(port, opt);\r\n  }\r\n\r\n  public createIOServer(port: number, options?: any): any {\r\n    if (this.httpServer && port === 0) {\r\n      return new Server(this.httpServer, options);\r\n    }\r\n    return new Server(port, options);\r\n  }\r\n\r\n  public bindMessageHandlers(\r\n    socket: Socket,\r\n    handlers: MessageMappingProperties[],\r\n    transform: (data: any) => Observable<any>,\r\n  ) {\r\n    const disconnect$ = fromEvent(socket, DISCONNECT_EVENT).pipe(\r\n      share(),\r\n      first(),\r\n    );\r\n\r\n    handlers.forEach(({ message, callback }) => {\r\n      const source$ = fromEvent(socket, message).pipe(\r\n        mergeMap((payload: any) => {\r\n          const { data, ack } = this.mapPayload(payload);\r\n          return transform(callback(data, ack)).pipe(\r\n            filter((response: any) => !isNil(response)),\r\n            map((response: any) => [response, ack]),\r\n          );\r\n        }),\r\n        takeUntil(disconnect$),\r\n      );\r\n      source$.subscribe(([response, ack]) => {\r\n        if (response.event) {\r\n          return socket.emit(response.event, response.data);\r\n        }\r\n        isFunction(ack) && ack(response);\r\n      });\r\n    });\r\n  }\r\n\r\n  public mapPayload(payload: unknown): { data: any; ack?: Function } {\r\n    if (!Array.isArray(payload)) {\r\n      if (isFunction(payload)) {\r\n        return { data: undefined, ack: payload as Function };\r\n      }\r\n      return { data: payload };\r\n    }\r\n    const lastElement = payload[payload.length - 1];\r\n    const isAck = isFunction(lastElement);\r\n    if (isAck) {\r\n      const size = payload.length - 1;\r\n      return {\r\n        data: size === 1 ? payload[0] : payload.slice(0, size),\r\n        ack: lastElement,\r\n      };\r\n    }\r\n    return { data: payload };\r\n  }\r\n}\r\n"]}