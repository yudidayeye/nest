{"version":3,"file":"client-nats.js","sourceRoot":"","sources":["client-nats.ts"],"names":[],"mappings":"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","sourcesContent":["import { Logger } from '@nestjs/common/services/logger.service';\r\nimport { loadPackage } from '@nestjs/common/utils/load-package.util';\r\nimport { isObject } from '@nestjs/common/utils/shared.utils';\r\nimport { NATS_DEFAULT_URL } from '../constants';\r\nimport { NatsResponseJSONDeserializer } from '../deserializers/nats-response-json.deserializer';\r\nimport { EmptyResponseException } from '../errors/empty-response.exception';\r\nimport { Client, NatsMsg } from '../external/nats-client.interface';\r\nimport { NatsOptions, PacketId, ReadPacket, WritePacket } from '../interfaces';\r\nimport { NatsRecord } from '../record-builders';\r\nimport { NatsRecordSerializer } from '../serializers/nats-record.serializer';\r\nimport { ClientProxy } from './client-proxy';\r\n\r\nlet natsPackage = {} as any;\r\n\r\n/**\r\n * @publicApi\r\n */\r\nexport class ClientNats extends ClientProxy {\r\n  protected readonly logger = new Logger(ClientNats.name);\r\n  protected natsClient: Client;\r\n\r\n  constructor(protected readonly options: NatsOptions['options']) {\r\n    super();\r\n    natsPackage = loadPackage('nats', ClientNats.name, () => require('nats'));\r\n\r\n    this.initializeSerializer(options);\r\n    this.initializeDeserializer(options);\r\n  }\r\n\r\n  public async close() {\r\n    await this.natsClient?.close();\r\n    this.natsClient = null;\r\n  }\r\n\r\n  public async connect(): Promise<any> {\r\n    if (this.natsClient) {\r\n      return this.natsClient;\r\n    }\r\n    this.natsClient = await this.createClient();\r\n    this.handleStatusUpdates(this.natsClient);\r\n    return this.natsClient;\r\n  }\r\n\r\n  public createClient(): Promise<Client> {\r\n    const options: any = this.options || ({} as NatsOptions);\r\n    return natsPackage.connect({\r\n      servers: NATS_DEFAULT_URL,\r\n      ...options,\r\n    });\r\n  }\r\n\r\n  public async handleStatusUpdates(client: Client) {\r\n    for await (const status of client.status()) {\r\n      const data =\r\n        status.data && isObject(status.data)\r\n          ? JSON.stringify(status.data)\r\n          : status.data;\r\n\r\n      switch (status.type) {\r\n        case 'error':\r\n        case 'disconnect':\r\n          this.logger.error(\r\n            `NatsError: type: \"${status.type}\", data: \"${data}\".`,\r\n          );\r\n          break;\r\n\r\n        case 'pingTimer':\r\n          if (this.options.debug) {\r\n            this.logger.debug(\r\n              `NatsStatus: type: \"${status.type}\", data: \"${data}\".`,\r\n            );\r\n          }\r\n          break;\r\n\r\n        default:\r\n          this.logger.log(\r\n            `NatsStatus: type: \"${status.type}\", data: \"${data}\".`,\r\n          );\r\n          break;\r\n      }\r\n    }\r\n  }\r\n\r\n  public createSubscriptionHandler(\r\n    packet: ReadPacket & PacketId,\r\n    callback: (packet: WritePacket) => any,\r\n  ) {\r\n    return async (error: unknown | undefined, natsMsg: NatsMsg) => {\r\n      if (error) {\r\n        return callback({\r\n          err: error,\r\n        });\r\n      }\r\n      const rawPacket = natsMsg.data;\r\n      if (rawPacket?.length === 0) {\r\n        return callback({\r\n          err: new EmptyResponseException(\r\n            this.normalizePattern(packet.pattern),\r\n          ),\r\n          isDisposed: true,\r\n        });\r\n      }\r\n      const message = await this.deserializer.deserialize(rawPacket);\r\n      if (message.id && message.id !== packet.id) {\r\n        return undefined;\r\n      }\r\n      const { err, response, isDisposed } = message;\r\n      if (isDisposed || err) {\r\n        return callback({\r\n          err,\r\n          response,\r\n          isDisposed: true,\r\n        });\r\n      }\r\n      callback({\r\n        err,\r\n        response,\r\n      });\r\n    };\r\n  }\r\n\r\n  protected publish(\r\n    partialPacket: ReadPacket,\r\n    callback: (packet: WritePacket) => any,\r\n  ): () => void {\r\n    try {\r\n      const packet = this.assignPacketId(partialPacket);\r\n      const channel = this.normalizePattern(partialPacket.pattern);\r\n      const serializedPacket: NatsRecord = this.serializer.serialize(packet);\r\n      const inbox = natsPackage.createInbox();\r\n\r\n      const subscriptionHandler = this.createSubscriptionHandler(\r\n        packet,\r\n        callback,\r\n      );\r\n\r\n      const subscription = this.natsClient.subscribe(inbox, {\r\n        callback: subscriptionHandler,\r\n      });\r\n\r\n      const headers = this.mergeHeaders(serializedPacket.headers);\r\n      this.natsClient.publish(channel, serializedPacket.data, {\r\n        reply: inbox,\r\n        headers,\r\n      });\r\n\r\n      return () => subscription.unsubscribe();\r\n    } catch (err) {\r\n      callback({ err });\r\n    }\r\n  }\r\n\r\n  protected dispatchEvent(packet: ReadPacket): Promise<any> {\r\n    const pattern = this.normalizePattern(packet.pattern);\r\n    const serializedPacket: NatsRecord = this.serializer.serialize(packet);\r\n    const headers = this.mergeHeaders(serializedPacket.headers);\r\n\r\n    return new Promise<void>((resolve, reject) => {\r\n      try {\r\n        this.natsClient.publish(pattern, serializedPacket.data, {\r\n          headers,\r\n        });\r\n        resolve();\r\n      } catch (err) {\r\n        reject(err);\r\n      }\r\n    });\r\n  }\r\n\r\n  protected initializeSerializer(options: NatsOptions['options']) {\r\n    this.serializer = options?.serializer ?? new NatsRecordSerializer();\r\n  }\r\n\r\n  protected initializeDeserializer(options: NatsOptions['options']) {\r\n    this.deserializer =\r\n      options?.deserializer ?? new NatsResponseJSONDeserializer();\r\n  }\r\n\r\n  protected mergeHeaders<THeaders = any>(requestHeaders?: THeaders) {\r\n    if (!requestHeaders && !this.options?.headers) {\r\n      return undefined;\r\n    }\r\n\r\n    const headers = requestHeaders ?? natsPackage.headers();\r\n\r\n    for (const [key, value] of Object.entries(this.options?.headers || {})) {\r\n      if (!headers.has(key)) {\r\n        headers.set(key, value);\r\n      }\r\n    }\r\n\r\n    return headers;\r\n  }\r\n}\r\n"]}