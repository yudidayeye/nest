{"version":3,"file":"client-rmq.js","sourceRoot":"","sources":["client-rmq.ts"],"names":[],"mappings":"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","sourcesContent":["import { Logger } from '@nestjs/common/services/logger.service';\r\nimport { loadPackage } from '@nestjs/common/utils/load-package.util';\r\nimport { randomStringGenerator } from '@nestjs/common/utils/random-string-generator.util';\r\nimport { isFunction } from '@nestjs/common/utils/shared.utils';\r\nimport { EventEmitter } from 'events';\r\nimport {\r\n  EmptyError,\r\n  firstValueFrom,\r\n  fromEvent,\r\n  merge,\r\n  Observable,\r\n  ReplaySubject,\r\n} from 'rxjs';\r\nimport { first, map, retryWhen, scan, skip, switchMap } from 'rxjs/operators';\r\nimport {\r\n  CONNECT_EVENT,\r\n  CONNECT_FAILED_EVENT,\r\n  DISCONNECT_EVENT,\r\n  DISCONNECTED_RMQ_MESSAGE,\r\n  ERROR_EVENT,\r\n  RQM_DEFAULT_IS_GLOBAL_PREFETCH_COUNT,\r\n  RQM_DEFAULT_NO_ASSERT,\r\n  RQM_DEFAULT_NOACK,\r\n  RQM_DEFAULT_PERSISTENT,\r\n  RQM_DEFAULT_PREFETCH_COUNT,\r\n  RQM_DEFAULT_QUEUE,\r\n  RQM_DEFAULT_QUEUE_OPTIONS,\r\n  RQM_DEFAULT_URL,\r\n} from '../constants';\r\nimport { RmqUrl } from '../external/rmq-url.interface';\r\nimport { ReadPacket, RmqOptions, WritePacket } from '../interfaces';\r\nimport { RmqRecord } from '../record-builders';\r\nimport { RmqRecordSerializer } from '../serializers/rmq-record.serializer';\r\nimport { ClientProxy } from './client-proxy';\r\n\r\n// import type {\r\n//   AmqpConnectionManager,\r\n//   ChannelWrapper,\r\n// } from 'amqp-connection-manager';\r\n// import type { Channel, ConsumeMessage } from 'amqplib';\r\n\r\ntype Channel = any;\r\ntype ChannelWrapper = any;\r\ntype ConsumeMessage = any;\r\ntype AmqpConnectionManager = any;\r\n\r\nlet rqmPackage: any = {};\r\n\r\nconst REPLY_QUEUE = 'amq.rabbitmq.reply-to';\r\n\r\n/**\r\n * @publicApi\r\n */\r\nexport class ClientRMQ extends ClientProxy {\r\n  protected readonly logger = new Logger(ClientProxy.name);\r\n  protected connection$: ReplaySubject<any>;\r\n  protected connection: Promise<any>;\r\n  protected client: AmqpConnectionManager = null;\r\n  protected channel: ChannelWrapper = null;\r\n  protected urls: string[] | RmqUrl[];\r\n  protected queue: string;\r\n  protected queueOptions: Record<string, any>;\r\n  protected responseEmitter: EventEmitter;\r\n  protected replyQueue: string;\r\n  protected persistent: boolean;\r\n  protected noAssert: boolean;\r\n\r\n  constructor(protected readonly options: RmqOptions['options']) {\r\n    super();\r\n    this.urls = this.getOptionsProp(this.options, 'urls') || [RQM_DEFAULT_URL];\r\n    this.queue =\r\n      this.getOptionsProp(this.options, 'queue') || RQM_DEFAULT_QUEUE;\r\n    this.queueOptions =\r\n      this.getOptionsProp(this.options, 'queueOptions') ||\r\n      RQM_DEFAULT_QUEUE_OPTIONS;\r\n    this.replyQueue =\r\n      this.getOptionsProp(this.options, 'replyQueue') || REPLY_QUEUE;\r\n    this.persistent =\r\n      this.getOptionsProp(this.options, 'persistent') || RQM_DEFAULT_PERSISTENT;\r\n    this.noAssert =\r\n      this.getOptionsProp(this.options, 'noAssert') || RQM_DEFAULT_NO_ASSERT;\r\n\r\n    loadPackage('amqplib', ClientRMQ.name, () => require('amqplib'));\r\n    rqmPackage = loadPackage('amqp-connection-manager', ClientRMQ.name, () =>\r\n      require('amqp-connection-manager'),\r\n    );\r\n\r\n    this.initializeSerializer(options);\r\n    this.initializeDeserializer(options);\r\n  }\r\n\r\n  public close(): void {\r\n    this.channel && this.channel.close();\r\n    this.client && this.client.close();\r\n    this.channel = null;\r\n    this.client = null;\r\n  }\r\n\r\n  public connect(): Promise<any> {\r\n    if (this.client) {\r\n      return this.convertConnectionToPromise();\r\n    }\r\n    this.client = this.createClient();\r\n    this.handleError(this.client);\r\n    this.handleDisconnectError(this.client);\r\n\r\n    this.responseEmitter = new EventEmitter();\r\n    this.responseEmitter.setMaxListeners(0);\r\n\r\n    const connect$ = this.connect$(this.client);\r\n    const withDisconnect$ = this.mergeDisconnectEvent(\r\n      this.client,\r\n      connect$,\r\n    ).pipe(switchMap(() => this.createChannel()));\r\n\r\n    const withReconnect$ = fromEvent(this.client, CONNECT_EVENT).pipe(skip(1));\r\n    const source$ = merge(withDisconnect$, withReconnect$);\r\n\r\n    this.connection$ = new ReplaySubject(1);\r\n    source$.subscribe(this.connection$);\r\n\r\n    return this.convertConnectionToPromise();\r\n  }\r\n\r\n  public createChannel(): Promise<void> {\r\n    return new Promise(resolve => {\r\n      this.channel = this.client.createChannel({\r\n        json: false,\r\n        setup: (channel: Channel) => this.setupChannel(channel, resolve),\r\n      });\r\n    });\r\n  }\r\n\r\n  public createClient(): AmqpConnectionManager {\r\n    const socketOptions = this.getOptionsProp(this.options, 'socketOptions');\r\n    return rqmPackage.connect(this.urls, {\r\n      connectionOptions: socketOptions,\r\n    });\r\n  }\r\n\r\n  public mergeDisconnectEvent<T = any>(\r\n    instance: any,\r\n    source$: Observable<T>,\r\n  ): Observable<T> {\r\n    const eventToError = (eventType: string) =>\r\n      fromEvent(instance, eventType).pipe(\r\n        map((err: unknown) => {\r\n          throw err;\r\n        }),\r\n      );\r\n    const disconnect$ = eventToError(DISCONNECT_EVENT);\r\n\r\n    const urls = this.getOptionsProp(this.options, 'urls', []);\r\n    const connectFailed$ = eventToError(CONNECT_FAILED_EVENT).pipe(\r\n      retryWhen(e =>\r\n        e.pipe(\r\n          scan((errorCount, error: any) => {\r\n            if (urls.indexOf(error.url) >= urls.length - 1) {\r\n              throw error;\r\n            }\r\n            return errorCount + 1;\r\n          }, 0),\r\n        ),\r\n      ),\r\n    );\r\n    // If we ever decide to propagate all disconnect errors & re-emit them through\r\n    // the \"connection\" stream then comment out \"first()\" operator.\r\n    return merge(source$, disconnect$, connectFailed$).pipe(first());\r\n  }\r\n\r\n  public async convertConnectionToPromise() {\r\n    try {\r\n      return await firstValueFrom(this.connection$);\r\n    } catch (err) {\r\n      if (err instanceof EmptyError) {\r\n        return;\r\n      }\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  public async setupChannel(channel: Channel, resolve: Function) {\r\n    const prefetchCount =\r\n      this.getOptionsProp(this.options, 'prefetchCount') ||\r\n      RQM_DEFAULT_PREFETCH_COUNT;\r\n    const isGlobalPrefetchCount =\r\n      this.getOptionsProp(this.options, 'isGlobalPrefetchCount') ||\r\n      RQM_DEFAULT_IS_GLOBAL_PREFETCH_COUNT;\r\n\r\n    if (!this.queueOptions.noAssert) {\r\n      await channel.assertQueue(this.queue, this.queueOptions);\r\n    }\r\n    await channel.prefetch(prefetchCount, isGlobalPrefetchCount);\r\n    await this.consumeChannel(channel);\r\n    resolve();\r\n  }\r\n\r\n  public async consumeChannel(channel: Channel) {\r\n    const noAck = this.getOptionsProp(this.options, 'noAck', RQM_DEFAULT_NOACK);\r\n    await channel.consume(\r\n      this.replyQueue,\r\n      (msg: ConsumeMessage) =>\r\n        this.responseEmitter.emit(msg.properties.correlationId, msg),\r\n      {\r\n        noAck,\r\n      },\r\n    );\r\n  }\r\n\r\n  public handleError(client: AmqpConnectionManager): void {\r\n    client.addListener(ERROR_EVENT, (err: any) => this.logger.error(err));\r\n  }\r\n\r\n  public handleDisconnectError(client: AmqpConnectionManager): void {\r\n    client.addListener(DISCONNECT_EVENT, (err: any) => {\r\n      this.logger.error(DISCONNECTED_RMQ_MESSAGE);\r\n      this.logger.error(err);\r\n    });\r\n  }\r\n\r\n  public async handleMessage(\r\n    packet: unknown,\r\n    callback: (packet: WritePacket) => any,\r\n  );\r\n  public async handleMessage(\r\n    packet: unknown,\r\n    options: Record<string, unknown>,\r\n    callback: (packet: WritePacket) => any,\r\n  );\r\n  public async handleMessage(\r\n    packet: unknown,\r\n    options: Record<string, unknown> | ((packet: WritePacket) => any),\r\n    callback?: (packet: WritePacket) => any,\r\n  ) {\r\n    if (isFunction(options)) {\r\n      callback = options as (packet: WritePacket) => any;\r\n      options = undefined;\r\n    }\r\n\r\n    const { err, response, isDisposed } = await this.deserializer.deserialize(\r\n      packet,\r\n      options,\r\n    );\r\n    if (isDisposed || err) {\r\n      callback({\r\n        err,\r\n        response,\r\n        isDisposed: true,\r\n      });\r\n    }\r\n    callback({\r\n      err,\r\n      response,\r\n    });\r\n  }\r\n\r\n  protected publish(\r\n    message: ReadPacket,\r\n    callback: (packet: WritePacket) => any,\r\n  ): () => void {\r\n    try {\r\n      const correlationId = randomStringGenerator();\r\n      const listener = ({\r\n        content,\r\n        options,\r\n      }: {\r\n        content: Buffer;\r\n        options: Record<string, unknown>;\r\n      }) =>\r\n        this.handleMessage(\r\n          this.parseMessageContent(content),\r\n          options,\r\n          callback,\r\n        );\r\n\r\n      Object.assign(message, { id: correlationId });\r\n      const serializedPacket: ReadPacket & Partial<RmqRecord> =\r\n        this.serializer.serialize(message);\r\n\r\n      const options = serializedPacket.options;\r\n      delete serializedPacket.options;\r\n\r\n      this.responseEmitter.on(correlationId, listener);\r\n      this.channel\r\n        .sendToQueue(\r\n          this.queue,\r\n          Buffer.from(JSON.stringify(serializedPacket)),\r\n          {\r\n            replyTo: this.replyQueue,\r\n            persistent: this.persistent,\r\n            ...options,\r\n            headers: this.mergeHeaders(options?.headers),\r\n            correlationId,\r\n          },\r\n        )\r\n        .catch(err => callback({ err }));\r\n      return () => this.responseEmitter.removeListener(correlationId, listener);\r\n    } catch (err) {\r\n      callback({ err });\r\n    }\r\n  }\r\n\r\n  protected dispatchEvent(packet: ReadPacket): Promise<any> {\r\n    const serializedPacket: ReadPacket & Partial<RmqRecord> =\r\n      this.serializer.serialize(packet);\r\n\r\n    const options = serializedPacket.options;\r\n    delete serializedPacket.options;\r\n\r\n    return new Promise<void>((resolve, reject) =>\r\n      this.channel.sendToQueue(\r\n        this.queue,\r\n        Buffer.from(JSON.stringify(serializedPacket)),\r\n        {\r\n          persistent: this.persistent,\r\n          ...options,\r\n          headers: this.mergeHeaders(options?.headers),\r\n        },\r\n        (err: unknown) => (err ? reject(err) : resolve()),\r\n      ),\r\n    );\r\n  }\r\n\r\n  protected initializeSerializer(options: RmqOptions['options']) {\r\n    this.serializer = options?.serializer ?? new RmqRecordSerializer();\r\n  }\r\n\r\n  protected mergeHeaders(\r\n    requestHeaders?: Record<string, string>,\r\n  ): Record<string, string> | undefined {\r\n    if (!requestHeaders && !this.options?.headers) {\r\n      return undefined;\r\n    }\r\n\r\n    return {\r\n      ...this.options?.headers,\r\n      ...requestHeaders,\r\n    };\r\n  }\r\n\r\n  protected parseMessageContent(content: Buffer) {\r\n    const rawContent = content.toString();\r\n    try {\r\n      return JSON.parse(rawContent);\r\n    } catch {\r\n      return rawContent;\r\n    }\r\n  }\r\n}\r\n"]}