{"version":3,"file":"client-redis.js","sourceRoot":"","sources":["client-redis.ts"],"names":[],"mappings":"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","sourcesContent":["import { Logger } from '@nestjs/common/services/logger.service';\r\nimport { loadPackage } from '@nestjs/common/utils/load-package.util';\r\nimport {\r\n  ERROR_EVENT,\r\n  MESSAGE_EVENT,\r\n  REDIS_DEFAULT_HOST,\r\n  REDIS_DEFAULT_PORT,\r\n} from '../constants';\r\nimport { ReadPacket, RedisOptions, WritePacket } from '../interfaces';\r\nimport { ClientProxy } from './client-proxy';\r\n\r\ntype Redis = any;\r\n\r\nlet redisPackage = {} as any;\r\n\r\n/**\r\n * @publicApi\r\n */\r\nexport class ClientRedis extends ClientProxy {\r\n  protected readonly logger = new Logger(ClientProxy.name);\r\n  protected readonly subscriptionsCount = new Map<string, number>();\r\n  protected pubClient: Redis;\r\n  protected subClient: Redis;\r\n  protected connection: Promise<any>;\r\n  protected isExplicitlyTerminated = false;\r\n\r\n  constructor(protected readonly options: RedisOptions['options']) {\r\n    super();\r\n\r\n    redisPackage = loadPackage('ioredis', ClientRedis.name, () =>\r\n      require('ioredis'),\r\n    );\r\n\r\n    this.initializeSerializer(options);\r\n    this.initializeDeserializer(options);\r\n  }\r\n\r\n  public getRequestPattern(pattern: string): string {\r\n    return pattern;\r\n  }\r\n\r\n  public getReplyPattern(pattern: string): string {\r\n    return `${pattern}.reply`;\r\n  }\r\n\r\n  public close() {\r\n    this.pubClient && this.pubClient.quit();\r\n    this.subClient && this.subClient.quit();\r\n    this.pubClient = this.subClient = null;\r\n    this.isExplicitlyTerminated = true;\r\n  }\r\n\r\n  public async connect(): Promise<any> {\r\n    if (this.pubClient && this.subClient) {\r\n      return this.connection;\r\n    }\r\n    this.pubClient = this.createClient();\r\n    this.subClient = this.createClient();\r\n    this.handleError(this.pubClient);\r\n    this.handleError(this.subClient);\r\n\r\n    this.connection = Promise.all([\r\n      this.subClient.connect(),\r\n      this.pubClient.connect(),\r\n    ]);\r\n    await this.connection;\r\n\r\n    this.subClient.on(MESSAGE_EVENT, this.createResponseCallback());\r\n    return this.connection;\r\n  }\r\n\r\n  public createClient(): Redis {\r\n    return new redisPackage({\r\n      host: REDIS_DEFAULT_HOST,\r\n      port: REDIS_DEFAULT_PORT,\r\n      ...this.getClientOptions(),\r\n      lazyConnect: true,\r\n    });\r\n  }\r\n\r\n  public handleError(client: Redis) {\r\n    client.addListener(ERROR_EVENT, (err: any) => this.logger.error(err));\r\n  }\r\n\r\n  public getClientOptions(): Partial<RedisOptions['options']> {\r\n    const retryStrategy = (times: number) => this.createRetryStrategy(times);\r\n\r\n    return {\r\n      ...(this.options || {}),\r\n      retryStrategy,\r\n    };\r\n  }\r\n\r\n  public createRetryStrategy(times: number): undefined | number {\r\n    if (this.isExplicitlyTerminated) {\r\n      return undefined;\r\n    }\r\n    if (\r\n      !this.getOptionsProp(this.options, 'retryAttempts') ||\r\n      times > this.getOptionsProp(this.options, 'retryAttempts')\r\n    ) {\r\n      this.logger.error('Retry time exhausted');\r\n      return;\r\n    }\r\n    return this.getOptionsProp(this.options, 'retryDelay') || 0;\r\n  }\r\n\r\n  public createResponseCallback(): (\r\n    channel: string,\r\n    buffer: string,\r\n  ) => Promise<void> {\r\n    return async (channel: string, buffer: string) => {\r\n      const packet = JSON.parse(buffer);\r\n      const { err, response, isDisposed, id } =\r\n        await this.deserializer.deserialize(packet);\r\n\r\n      const callback = this.routingMap.get(id);\r\n      if (!callback) {\r\n        return;\r\n      }\r\n      if (isDisposed || err) {\r\n        return callback({\r\n          err,\r\n          response,\r\n          isDisposed: true,\r\n        });\r\n      }\r\n      callback({\r\n        err,\r\n        response,\r\n      });\r\n    };\r\n  }\r\n\r\n  protected publish(\r\n    partialPacket: ReadPacket,\r\n    callback: (packet: WritePacket) => any,\r\n  ): () => void {\r\n    try {\r\n      const packet = this.assignPacketId(partialPacket);\r\n      const pattern = this.normalizePattern(partialPacket.pattern);\r\n      const serializedPacket = this.serializer.serialize(packet);\r\n      const responseChannel = this.getReplyPattern(pattern);\r\n      let subscriptionsCount =\r\n        this.subscriptionsCount.get(responseChannel) || 0;\r\n\r\n      const publishPacket = () => {\r\n        subscriptionsCount = this.subscriptionsCount.get(responseChannel) || 0;\r\n        this.subscriptionsCount.set(responseChannel, subscriptionsCount + 1);\r\n        this.routingMap.set(packet.id, callback);\r\n        this.pubClient.publish(\r\n          this.getRequestPattern(pattern),\r\n          JSON.stringify(serializedPacket),\r\n        );\r\n      };\r\n\r\n      if (subscriptionsCount <= 0) {\r\n        this.subClient.subscribe(\r\n          responseChannel,\r\n          (err: any) => !err && publishPacket(),\r\n        );\r\n      } else {\r\n        publishPacket();\r\n      }\r\n\r\n      return () => {\r\n        this.unsubscribeFromChannel(responseChannel);\r\n        this.routingMap.delete(packet.id);\r\n      };\r\n    } catch (err) {\r\n      callback({ err });\r\n    }\r\n  }\r\n\r\n  protected dispatchEvent(packet: ReadPacket): Promise<any> {\r\n    const pattern = this.normalizePattern(packet.pattern);\r\n    const serializedPacket = this.serializer.serialize(packet);\r\n\r\n    return new Promise<void>((resolve, reject) =>\r\n      this.pubClient.publish(pattern, JSON.stringify(serializedPacket), err =>\r\n        err ? reject(err) : resolve(),\r\n      ),\r\n    );\r\n  }\r\n\r\n  protected unsubscribeFromChannel(channel: string) {\r\n    const subscriptionCount = this.subscriptionsCount.get(channel);\r\n    this.subscriptionsCount.set(channel, subscriptionCount - 1);\r\n\r\n    if (subscriptionCount - 1 <= 0) {\r\n      this.subClient.unsubscribe(channel);\r\n    }\r\n  }\r\n}\r\n"]}