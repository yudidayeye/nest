{"version":3,"file":"clients.module.js","sourceRoot":"","sources":["clients.module.ts"],"names":[],"mappings":"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","sourcesContent":["import {\r\n  DynamicModule,\r\n  Module,\r\n  OnApplicationShutdown,\r\n  Provider,\r\n} from '@nestjs/common';\r\nimport { ClientProxy, ClientProxyFactory } from '../client';\r\nimport { Closeable } from '../interfaces';\r\nimport {\r\n  ClientsModuleAsyncOptions,\r\n  ClientsModuleOptions,\r\n  ClientsModuleOptionsFactory,\r\n  ClientsProviderAsyncOptions,\r\n} from './interfaces';\r\n\r\n@Module({})\r\nexport class ClientsModule {\r\n  static register(options: ClientsModuleOptions): DynamicModule {\r\n    const clientsOptions = !Array.isArray(options) ? options.clients : options;\r\n    const clients = (clientsOptions || []).map(item => ({\r\n      provide: item.name,\r\n      useValue: this.assignOnAppShutdownHook(ClientProxyFactory.create(item)),\r\n    }));\r\n    return {\r\n      module: ClientsModule,\r\n      global: !Array.isArray(options) && options.isGlobal,\r\n      providers: clients,\r\n      exports: clients,\r\n    };\r\n  }\r\n\r\n  static registerAsync(options: ClientsModuleAsyncOptions): DynamicModule {\r\n    const clientsOptions = !Array.isArray(options) ? options.clients : options;\r\n    const providers: Provider[] = clientsOptions.reduce(\r\n      (accProviders: Provider[], item) =>\r\n        accProviders\r\n          .concat(this.createAsyncProviders(item))\r\n          .concat(item.extraProviders || []),\r\n      [],\r\n    );\r\n    const imports = clientsOptions.reduce(\r\n      (accImports, option) =>\r\n        option.imports && !accImports.includes(option.imports)\r\n          ? accImports.concat(option.imports)\r\n          : accImports,\r\n      [],\r\n    );\r\n    return {\r\n      module: ClientsModule,\r\n      global: !Array.isArray(options) && options.isGlobal,\r\n      imports,\r\n      providers: providers,\r\n      exports: providers,\r\n    };\r\n  }\r\n\r\n  private static createAsyncProviders(\r\n    options: ClientsProviderAsyncOptions,\r\n  ): Provider[] {\r\n    if (options.useExisting || options.useFactory) {\r\n      return [this.createAsyncOptionsProvider(options)];\r\n    }\r\n    return [\r\n      this.createAsyncOptionsProvider(options),\r\n      {\r\n        provide: options.useClass,\r\n        useClass: options.useClass,\r\n      },\r\n    ];\r\n  }\r\n\r\n  private static createAsyncOptionsProvider(\r\n    options: ClientsProviderAsyncOptions,\r\n  ): Provider {\r\n    if (options.useFactory) {\r\n      return {\r\n        provide: options.name,\r\n        useFactory: this.createFactoryWrapper(options.useFactory),\r\n        inject: options.inject || [],\r\n      };\r\n    }\r\n    return {\r\n      provide: options.name,\r\n      useFactory: this.createFactoryWrapper(\r\n        (optionsFactory: ClientsModuleOptionsFactory) =>\r\n          optionsFactory.createClientOptions(),\r\n      ),\r\n      inject: [options.useExisting || options.useClass],\r\n    };\r\n  }\r\n\r\n  private static createFactoryWrapper(\r\n    useFactory: ClientsProviderAsyncOptions['useFactory'],\r\n  ) {\r\n    return async (...args: any[]) => {\r\n      const clientOptions = await useFactory(...args);\r\n      const clientProxyRef = ClientProxyFactory.create(clientOptions);\r\n      return this.assignOnAppShutdownHook(clientProxyRef);\r\n    };\r\n  }\r\n\r\n  private static assignOnAppShutdownHook(client: ClientProxy & Closeable) {\r\n    (client as unknown as OnApplicationShutdown).onApplicationShutdown =\r\n      client.close;\r\n    return client;\r\n  }\r\n}\r\n"]}