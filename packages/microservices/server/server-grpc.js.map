{"version":3,"file":"server-grpc.js","sourceRoot":"","sources":["server-grpc.ts"],"names":[],"mappings":"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","sourcesContent":["import {\r\n  isObject,\r\n  isString,\r\n  isUndefined,\r\n} from '@nestjs/common/utils/shared.utils';\r\nimport { EMPTY, fromEvent, lastValueFrom, Subject } from 'rxjs';\r\nimport { catchError, takeUntil } from 'rxjs/operators';\r\nimport {\r\n  CANCEL_EVENT,\r\n  GRPC_DEFAULT_PROTO_LOADER,\r\n  GRPC_DEFAULT_URL,\r\n} from '../constants';\r\nimport { GrpcMethodStreamingType } from '../decorators';\r\nimport { Transport } from '../enums';\r\nimport { InvalidGrpcPackageException } from '../errors/invalid-grpc-package.exception';\r\nimport { InvalidProtoDefinitionException } from '../errors/invalid-proto-definition.exception';\r\nimport { ChannelOptions } from '../external/grpc-options.interface';\r\nimport { CustomTransportStrategy, MessageHandler } from '../interfaces';\r\nimport { GrpcOptions } from '../interfaces/microservice-configuration.interface';\r\nimport { Server } from './server';\r\n\r\nlet grpcPackage: any = {};\r\nlet grpcProtoLoaderPackage: any = {};\r\n\r\ninterface GrpcCall<TRequest = any, TMetadata = any> {\r\n  request: TRequest;\r\n  metadata: TMetadata;\r\n  sendMetadata: Function;\r\n  end: Function;\r\n  write: Function;\r\n  on: Function;\r\n  emit: Function;\r\n}\r\n\r\nexport class ServerGrpc extends Server implements CustomTransportStrategy {\r\n  public readonly transportId = Transport.GRPC;\r\n\r\n  private readonly url: string;\r\n  private grpcClient: any;\r\n\r\n  constructor(private readonly options: GrpcOptions['options']) {\r\n    super();\r\n    this.url = this.getOptionsProp(options, 'url') || GRPC_DEFAULT_URL;\r\n\r\n    const protoLoader =\r\n      this.getOptionsProp(options, 'protoLoader') || GRPC_DEFAULT_PROTO_LOADER;\r\n\r\n    grpcPackage = this.loadPackage('@grpc/grpc-js', ServerGrpc.name, () =>\r\n      require('@grpc/grpc-js'),\r\n    );\r\n    grpcProtoLoaderPackage = this.loadPackage(\r\n      protoLoader,\r\n      ServerGrpc.name,\r\n      () =>\r\n        protoLoader === GRPC_DEFAULT_PROTO_LOADER\r\n          ? require('@grpc/proto-loader')\r\n          : require(protoLoader),\r\n    );\r\n  }\r\n\r\n  public async listen(\r\n    callback: (err?: unknown, ...optionalParams: unknown[]) => void,\r\n  ) {\r\n    try {\r\n      this.grpcClient = await this.createClient();\r\n      await this.start(callback);\r\n    } catch (err) {\r\n      callback(err);\r\n    }\r\n  }\r\n\r\n  public async start(callback?: () => void) {\r\n    await this.bindEvents();\r\n    this.grpcClient.start();\r\n    callback();\r\n  }\r\n\r\n  public async bindEvents() {\r\n    const grpcContext = this.loadProto();\r\n    const packageOption = this.getOptionsProp(this.options, 'package');\r\n    const packageNames = Array.isArray(packageOption)\r\n      ? packageOption\r\n      : [packageOption];\r\n\r\n    for (const packageName of packageNames) {\r\n      const grpcPkg = this.lookupPackage(grpcContext, packageName);\r\n      await this.createServices(grpcPkg, packageName);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Will return all of the services along with their fully namespaced\r\n   * names as an array of objects.\r\n   * This method initiates recursive scan of grpcPkg object\r\n   */\r\n  public getServiceNames(grpcPkg: any): { name: string; service: any }[] {\r\n    // Define accumulator to collect all of the services available to load\r\n    const services: { name: string; service: any }[] = [];\r\n    // Initiate recursive services collector starting with empty name\r\n    this.collectDeepServices('', grpcPkg, services);\r\n    return services;\r\n  }\r\n\r\n  /**\r\n   * Will create service mapping from gRPC generated Object to handlers\r\n   * defined with @GrpcMethod or @GrpcStreamMethod annotations\r\n   *\r\n   * @param grpcService\r\n   * @param name\r\n   */\r\n  public async createService(grpcService: any, name: string) {\r\n    const service = {};\r\n\r\n    for (const methodName in grpcService.prototype) {\r\n      let pattern = '';\r\n      let methodHandler = null;\r\n      let streamingType = GrpcMethodStreamingType.NO_STREAMING;\r\n\r\n      const methodFunction = grpcService.prototype[methodName];\r\n      const methodReqStreaming = methodFunction.requestStream;\r\n\r\n      if (!isUndefined(methodReqStreaming) && methodReqStreaming) {\r\n        // Try first pattern to be presented, RX streaming pattern would be\r\n        // a preferable pattern to select among a few defined\r\n        pattern = this.createPattern(\r\n          name,\r\n          methodName,\r\n          GrpcMethodStreamingType.RX_STREAMING,\r\n        );\r\n        methodHandler = this.messageHandlers.get(pattern);\r\n        streamingType = GrpcMethodStreamingType.RX_STREAMING;\r\n        // If first pattern didn't match to any of handlers then try\r\n        // pass-through handler to be presented\r\n        if (!methodHandler) {\r\n          pattern = this.createPattern(\r\n            name,\r\n            methodName,\r\n            GrpcMethodStreamingType.PT_STREAMING,\r\n          );\r\n          methodHandler = this.messageHandlers.get(pattern);\r\n          streamingType = GrpcMethodStreamingType.PT_STREAMING;\r\n        }\r\n      } else {\r\n        pattern = this.createPattern(\r\n          name,\r\n          methodName,\r\n          GrpcMethodStreamingType.NO_STREAMING,\r\n        );\r\n        // Select handler if any presented for No-Streaming pattern\r\n        methodHandler = this.messageHandlers.get(pattern);\r\n        streamingType = GrpcMethodStreamingType.NO_STREAMING;\r\n      }\r\n      if (!methodHandler) {\r\n        continue;\r\n      }\r\n      service[methodName] = await this.createServiceMethod(\r\n        methodHandler,\r\n        grpcService.prototype[methodName],\r\n        streamingType,\r\n      );\r\n    }\r\n    return service;\r\n  }\r\n\r\n  /**\r\n   * Will create a string of a JSON serialized format\r\n   *\r\n   * @param service name of the service which should be a match to gRPC service definition name\r\n   * @param methodName name of the method which is coming after rpc keyword\r\n   * @param streaming GrpcMethodStreamingType parameter which should correspond to\r\n   * stream keyword in gRPC service request part\r\n   */\r\n  public createPattern(\r\n    service: string,\r\n    methodName: string,\r\n    streaming: GrpcMethodStreamingType,\r\n  ): string {\r\n    return JSON.stringify({\r\n      service,\r\n      rpc: methodName,\r\n      streaming,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Will return async function which will handle gRPC call\r\n   * with Rx streams or as a direct call passthrough\r\n   *\r\n   * @param methodHandler\r\n   * @param protoNativeHandler\r\n   */\r\n  public createServiceMethod(\r\n    methodHandler: Function,\r\n    protoNativeHandler: any,\r\n    streamType: GrpcMethodStreamingType,\r\n  ): Function {\r\n    // If proto handler has request stream as \"true\" then we expect it to have\r\n    // streaming from the side of requester\r\n    if (protoNativeHandler.requestStream) {\r\n      // If any handlers were defined with GrpcStreamMethod annotation use RX\r\n      if (streamType === GrpcMethodStreamingType.RX_STREAMING) {\r\n        return this.createRequestStreamMethod(\r\n          methodHandler,\r\n          protoNativeHandler.responseStream,\r\n        );\r\n      }\r\n      // If any handlers were defined with GrpcStreamCall annotation\r\n      else if (streamType === GrpcMethodStreamingType.PT_STREAMING) {\r\n        return this.createStreamCallMethod(\r\n          methodHandler,\r\n          protoNativeHandler.responseStream,\r\n        );\r\n      }\r\n    }\r\n    return protoNativeHandler.responseStream\r\n      ? this.createStreamServiceMethod(methodHandler)\r\n      : this.createUnaryServiceMethod(methodHandler);\r\n  }\r\n\r\n  public createUnaryServiceMethod(methodHandler: Function): Function {\r\n    return async (call: GrpcCall, callback: Function) => {\r\n      const handler = methodHandler(call.request, call.metadata, call);\r\n      this.transformToObservable(await handler).subscribe({\r\n        next: async data => callback(null, await data),\r\n        error: (err: any) => callback(err),\r\n      });\r\n    };\r\n  }\r\n\r\n  public createStreamServiceMethod(methodHandler: Function): Function {\r\n    return async (call: GrpcCall, callback: Function) => {\r\n      const handler = methodHandler(call.request, call.metadata, call);\r\n      const result$ = this.transformToObservable(await handler);\r\n      await result$\r\n        .pipe(\r\n          takeUntil(fromEvent(call as any, CANCEL_EVENT)),\r\n          catchError(err => {\r\n            call.emit('error', err);\r\n            return EMPTY;\r\n          }),\r\n        )\r\n        .forEach(data => call.write(data));\r\n      call.end();\r\n    };\r\n  }\r\n\r\n  public createRequestStreamMethod(\r\n    methodHandler: Function,\r\n    isResponseStream: boolean,\r\n  ) {\r\n    return async (\r\n      call: GrpcCall,\r\n      callback: (err: unknown, value: unknown) => void,\r\n    ) => {\r\n      const req = new Subject<any>();\r\n      call.on('data', (m: any) => req.next(m));\r\n      call.on('error', (e: any) => {\r\n        // Check if error means that stream ended on other end\r\n        const isCancelledError = String(e).toLowerCase().indexOf('cancelled');\r\n\r\n        if (isCancelledError) {\r\n          call.end();\r\n          return;\r\n        }\r\n        // If another error then just pass it along\r\n        req.error(e);\r\n      });\r\n      call.on('end', () => req.complete());\r\n\r\n      const handler = methodHandler(req.asObservable(), call.metadata, call);\r\n      const res = this.transformToObservable(await handler);\r\n      if (isResponseStream) {\r\n        await res\r\n          .pipe(\r\n            takeUntil(fromEvent(call as any, CANCEL_EVENT)),\r\n            catchError(err => {\r\n              call.emit('error', err);\r\n              return EMPTY;\r\n            }),\r\n          )\r\n          .forEach(m => call.write(m));\r\n\r\n        call.end();\r\n      } else {\r\n        const response = await lastValueFrom(\r\n          res.pipe(\r\n            takeUntil(fromEvent(call as any, CANCEL_EVENT)),\r\n            catchError(err => {\r\n              callback(err, null);\r\n              return EMPTY;\r\n            }),\r\n          ),\r\n        );\r\n\r\n        if (!isUndefined(response)) {\r\n          callback(null, response);\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  public createStreamCallMethod(\r\n    methodHandler: Function,\r\n    isResponseStream: boolean,\r\n  ) {\r\n    return async (\r\n      call: GrpcCall,\r\n      callback: (err: unknown, value: unknown) => void,\r\n    ) => {\r\n      if (isResponseStream) {\r\n        methodHandler(call);\r\n      } else {\r\n        methodHandler(call, callback);\r\n      }\r\n    };\r\n  }\r\n\r\n  public async close(): Promise<void> {\r\n    if (this.grpcClient) {\r\n      const graceful = this.getOptionsProp(this.options, 'gracefulShutdown');\r\n      if (graceful) {\r\n        await new Promise<void>((resolve, reject) => {\r\n          this.grpcClient.tryShutdown((error: Error) => {\r\n            if (error) reject(error);\r\n            else resolve();\r\n          });\r\n        });\r\n      } else {\r\n        this.grpcClient.forceShutdown();\r\n      }\r\n    }\r\n    this.grpcClient = null;\r\n  }\r\n\r\n  public deserialize(obj: any): any {\r\n    try {\r\n      return JSON.parse(obj);\r\n    } catch (e) {\r\n      return obj;\r\n    }\r\n  }\r\n\r\n  public addHandler(\r\n    pattern: unknown,\r\n    callback: MessageHandler,\r\n    isEventHandler = false,\r\n  ) {\r\n    const route = isString(pattern) ? pattern : JSON.stringify(pattern);\r\n    callback.isEventHandler = isEventHandler;\r\n    this.messageHandlers.set(route, callback);\r\n  }\r\n\r\n  public async createClient(): Promise<any> {\r\n    const channelOptions: ChannelOptions =\r\n      this.options && this.options.channelOptions\r\n        ? this.options.channelOptions\r\n        : {};\r\n    if (this.options && this.options.maxSendMessageLength) {\r\n      channelOptions['grpc.max_send_message_length'] =\r\n        this.options.maxSendMessageLength;\r\n    }\r\n    if (this.options && this.options.maxReceiveMessageLength) {\r\n      channelOptions['grpc.max_receive_message_length'] =\r\n        this.options.maxReceiveMessageLength;\r\n    }\r\n    if (this.options && this.options.maxMetadataSize) {\r\n      channelOptions['grpc.max_metadata_size'] = this.options.maxMetadataSize;\r\n    }\r\n    const server = new grpcPackage.Server(channelOptions);\r\n    const credentials = this.getOptionsProp(this.options, 'credentials');\r\n\r\n    await new Promise((resolve, reject) => {\r\n      server.bindAsync(\r\n        this.url,\r\n        credentials || grpcPackage.ServerCredentials.createInsecure(),\r\n        (error: Error | null, port: number) =>\r\n          error ? reject(error) : resolve(port),\r\n      );\r\n    });\r\n\r\n    return server;\r\n  }\r\n\r\n  public lookupPackage(root: any, packageName: string) {\r\n    /** Reference: https://github.com/kondi/rxjs-grpc */\r\n    let pkg = root;\r\n    for (const name of packageName.split(/\\./)) {\r\n      pkg = pkg[name];\r\n    }\r\n    return pkg;\r\n  }\r\n\r\n  public loadProto(): any {\r\n    try {\r\n      const file = this.getOptionsProp(this.options, 'protoPath');\r\n      const loader = this.getOptionsProp(this.options, 'loader');\r\n\r\n      const packageDefinition = grpcProtoLoaderPackage.loadSync(file, loader);\r\n      const packageObject =\r\n        grpcPackage.loadPackageDefinition(packageDefinition);\r\n      return packageObject;\r\n    } catch (err) {\r\n      const invalidProtoError = new InvalidProtoDefinitionException(err.path);\r\n      const message =\r\n        err && err.message ? err.message : invalidProtoError.message;\r\n\r\n      this.logger.error(message, invalidProtoError.stack);\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Recursively fetch all of the service methods available on loaded\r\n   * protobuf descriptor object, and collect those as an objects with\r\n   * dot-syntax full-path names.\r\n   *\r\n   * Example:\r\n   *  for proto package Bundle.FirstService with service Events { rpc...\r\n   *  will be resolved to object of (while loaded for Bundle package):\r\n   *    {\r\n   *      name: \"FirstService.Events\",\r\n   *      service: {Object}\r\n   *    }\r\n   */\r\n  private collectDeepServices(\r\n    name: string,\r\n    grpcDefinition: any,\r\n    accumulator: { name: string; service: any }[],\r\n  ) {\r\n    if (!isObject(grpcDefinition)) {\r\n      return;\r\n    }\r\n    const keysToTraverse = Object.keys(grpcDefinition);\r\n    // Traverse definitions or namespace extensions\r\n    for (const key of keysToTraverse) {\r\n      const nameExtended = this.parseDeepServiceName(name, key);\r\n      const deepDefinition = grpcDefinition[key];\r\n\r\n      const isServiceDefined =\r\n        deepDefinition && !isUndefined(deepDefinition.service);\r\n      const isServiceBoolean = isServiceDefined\r\n        ? deepDefinition.service !== false\r\n        : false;\r\n\r\n      if (isServiceDefined && isServiceBoolean) {\r\n        accumulator.push({\r\n          name: nameExtended,\r\n          service: deepDefinition,\r\n        });\r\n      }\r\n      // Continue recursion until objects end or service definition found\r\n      else {\r\n        this.collectDeepServices(nameExtended, deepDefinition, accumulator);\r\n      }\r\n    }\r\n  }\r\n\r\n  private parseDeepServiceName(name: string, key: string): string {\r\n    // If depth is zero then just return key\r\n    if (name.length === 0) {\r\n      return key;\r\n    }\r\n    // Otherwise add next through dot syntax\r\n    return name + '.' + key;\r\n  }\r\n\r\n  private async createServices(grpcPkg: any, packageName: string) {\r\n    if (!grpcPkg) {\r\n      const invalidPackageError = new InvalidGrpcPackageException(packageName);\r\n      this.logger.error(invalidPackageError.message, invalidPackageError.stack);\r\n      throw invalidPackageError;\r\n    }\r\n\r\n    // Take all of the services defined in grpcPkg and assign them to\r\n    // method handlers defined in Controllers\r\n    for (const definition of this.getServiceNames(grpcPkg)) {\r\n      this.grpcClient.addService(\r\n        // First parameter requires exact service definition from proto\r\n        definition.service.service,\r\n        // Here full proto definition required along with namespaced pattern name\r\n        await this.createService(definition.service, definition.name),\r\n      );\r\n    }\r\n  }\r\n}\r\n"]}