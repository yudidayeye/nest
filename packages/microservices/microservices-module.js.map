{"version":3,"file":"microservices-module.js","sourceRoot":"","sources":["microservices-module.ts"],"names":[],"mappings":"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","sourcesContent":["import { Controller } from '@nestjs/common/interfaces/controllers/controller.interface';\r\nimport { NestApplicationContextOptions } from '@nestjs/common/interfaces/nest-application-context-options.interface';\r\nimport { ApplicationConfig } from '@nestjs/core/application-config';\r\nimport { RuntimeException } from '@nestjs/core/errors/exceptions/runtime.exception';\r\nimport { GuardsConsumer, GuardsContextCreator } from '@nestjs/core/guards';\r\nimport { NestContainer } from '@nestjs/core/injector/container';\r\nimport { Injector } from '@nestjs/core/injector/injector';\r\nimport { InstanceWrapper } from '@nestjs/core/injector/instance-wrapper';\r\nimport { GraphInspector } from '@nestjs/core/inspector/graph-inspector';\r\nimport {\r\n  InterceptorsConsumer,\r\n  InterceptorsContextCreator,\r\n} from '@nestjs/core/interceptors';\r\nimport { PipesConsumer, PipesContextCreator } from '@nestjs/core/pipes';\r\nimport { ClientProxyFactory } from './client';\r\nimport { ClientsContainer } from './container';\r\nimport { ExceptionFiltersContext } from './context/exception-filters-context';\r\nimport { RpcContextCreator } from './context/rpc-context-creator';\r\nimport { RpcProxy } from './context/rpc-proxy';\r\nimport { CustomTransportStrategy } from './interfaces';\r\nimport { ListenersController } from './listeners-controller';\r\nimport { Server } from './server/server';\r\n\r\nexport class MicroservicesModule<\r\n  TAppOptions extends NestApplicationContextOptions = NestApplicationContextOptions,\r\n> {\r\n  private readonly clientsContainer = new ClientsContainer();\r\n  private listenersController: ListenersController;\r\n  private appOptions: TAppOptions;\r\n\r\n  public register(\r\n    container: NestContainer,\r\n    graphInspector: GraphInspector,\r\n    config: ApplicationConfig,\r\n    options: TAppOptions,\r\n  ) {\r\n    this.appOptions = options;\r\n    const exceptionFiltersContext = new ExceptionFiltersContext(\r\n      container,\r\n      config,\r\n    );\r\n    const contextCreator = new RpcContextCreator(\r\n      new RpcProxy(),\r\n      exceptionFiltersContext,\r\n      new PipesContextCreator(container, config),\r\n      new PipesConsumer(),\r\n      new GuardsContextCreator(container, config),\r\n      new GuardsConsumer(),\r\n      new InterceptorsContextCreator(container, config),\r\n      new InterceptorsConsumer(),\r\n    );\r\n\r\n    const injector = new Injector();\r\n    this.listenersController = new ListenersController(\r\n      this.clientsContainer,\r\n      contextCreator,\r\n      container,\r\n      injector,\r\n      ClientProxyFactory,\r\n      exceptionFiltersContext,\r\n      graphInspector,\r\n    );\r\n  }\r\n\r\n  public setupListeners(\r\n    container: NestContainer,\r\n    server: Server & CustomTransportStrategy,\r\n  ) {\r\n    if (!this.listenersController) {\r\n      throw new RuntimeException();\r\n    }\r\n    const modules = container.getModules();\r\n    modules.forEach(({ controllers }, moduleRef) =>\r\n      this.bindListeners(controllers, server, moduleRef),\r\n    );\r\n  }\r\n\r\n  public setupClients(container: NestContainer) {\r\n    if (!this.listenersController) {\r\n      throw new RuntimeException();\r\n    }\r\n    if (this.appOptions?.preview) {\r\n      return;\r\n    }\r\n    const modules = container.getModules();\r\n    modules.forEach(({ controllers, providers }) => {\r\n      this.bindClients(controllers);\r\n      this.bindClients(providers);\r\n    });\r\n  }\r\n\r\n  public bindListeners(\r\n    controllers: Map<string | symbol | Function, InstanceWrapper<Controller>>,\r\n    server: Server & CustomTransportStrategy,\r\n    moduleName: string,\r\n  ) {\r\n    controllers.forEach(wrapper =>\r\n      this.listenersController.registerPatternHandlers(\r\n        wrapper,\r\n        server,\r\n        moduleName,\r\n      ),\r\n    );\r\n  }\r\n\r\n  public bindClients(\r\n    items: Map<string | symbol | Function, InstanceWrapper<unknown>>,\r\n  ) {\r\n    items.forEach(({ instance, isNotMetatype }) => {\r\n      !isNotMetatype &&\r\n        this.listenersController.assignClientsToProperties(instance);\r\n    });\r\n  }\r\n\r\n  public async close() {\r\n    const clients = this.clientsContainer.getAllClients();\r\n    await Promise.all(clients.map(client => client.close()));\r\n    this.clientsContainer.clear();\r\n  }\r\n}\r\n"]}