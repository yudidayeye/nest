{"version":3,"file":"web-sockets-controller.js","sourceRoot":"","sources":["web-sockets-controller.ts"],"names":[],"mappings":"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","sourcesContent":["import { NestApplicationContextOptions } from '@nestjs/common/interfaces/nest-application-context-options.interface';\r\nimport { Type } from '@nestjs/common/interfaces/type.interface';\r\nimport { Logger } from '@nestjs/common/services/logger.service';\r\nimport { ApplicationConfig } from '@nestjs/core/application-config';\r\nimport { GraphInspector } from '@nestjs/core/inspector/graph-inspector';\r\nimport { MetadataScanner } from '@nestjs/core/metadata-scanner';\r\nimport {\r\n  from as fromPromise,\r\n  isObservable,\r\n  Observable,\r\n  of,\r\n  Subject,\r\n} from 'rxjs';\r\nimport { distinctUntilChanged, mergeAll } from 'rxjs/operators';\r\nimport { GATEWAY_OPTIONS, PORT_METADATA } from './constants';\r\nimport { WsContextCreator } from './context/ws-context-creator';\r\nimport { InvalidSocketPortException } from './errors/invalid-socket-port.exception';\r\nimport {\r\n  GatewayMetadataExplorer,\r\n  MessageMappingProperties,\r\n} from './gateway-metadata-explorer';\r\nimport { GatewayMetadata } from './interfaces/gateway-metadata.interface';\r\nimport { NestGateway } from './interfaces/nest-gateway.interface';\r\nimport { ServerAndEventStreamsHost } from './interfaces/server-and-event-streams-host.interface';\r\nimport { WebsocketEntrypointMetadata } from './interfaces/websockets-entrypoint-metadata.interface';\r\nimport { SocketServerProvider } from './socket-server-provider';\r\nimport { compareElementAt } from './utils/compare-element.util';\r\n\r\nexport class WebSocketsController {\r\n  private readonly logger = new Logger(WebSocketsController.name, {\r\n    timestamp: true,\r\n  });\r\n  private readonly metadataExplorer = new GatewayMetadataExplorer(\r\n    new MetadataScanner(),\r\n  );\r\n\r\n  constructor(\r\n    private readonly socketServerProvider: SocketServerProvider,\r\n    private readonly config: ApplicationConfig,\r\n    private readonly contextCreator: WsContextCreator,\r\n    private readonly graphInspector: GraphInspector,\r\n    private readonly appOptions: NestApplicationContextOptions = {},\r\n  ) {}\r\n\r\n  public connectGatewayToServer(\r\n    instance: NestGateway,\r\n    metatype: Type<unknown> | Function,\r\n    moduleKey: string,\r\n    instanceWrapperId: string,\r\n  ) {\r\n    const options = Reflect.getMetadata(GATEWAY_OPTIONS, metatype) || {};\r\n    const port = Reflect.getMetadata(PORT_METADATA, metatype) || 0;\r\n\r\n    if (!Number.isInteger(port)) {\r\n      throw new InvalidSocketPortException(port, metatype);\r\n    }\r\n    this.subscribeToServerEvents(\r\n      instance,\r\n      options,\r\n      port,\r\n      moduleKey,\r\n      instanceWrapperId,\r\n    );\r\n  }\r\n\r\n  public subscribeToServerEvents<T extends GatewayMetadata>(\r\n    instance: NestGateway,\r\n    options: T,\r\n    port: number,\r\n    moduleKey: string,\r\n    instanceWrapperId: string,\r\n  ) {\r\n    const nativeMessageHandlers = this.metadataExplorer.explore(instance);\r\n    const messageHandlers = nativeMessageHandlers.map(\r\n      ({ callback, message, methodName }) => ({\r\n        message,\r\n        methodName,\r\n        callback: this.contextCreator.create(\r\n          instance,\r\n          callback,\r\n          moduleKey,\r\n          methodName,\r\n        ),\r\n      }),\r\n    );\r\n\r\n    this.inspectEntrypointDefinitions(\r\n      instance,\r\n      port,\r\n      messageHandlers,\r\n      instanceWrapperId,\r\n    );\r\n\r\n    if (this.appOptions.preview) {\r\n      return;\r\n    }\r\n    const observableServer = this.socketServerProvider.scanForSocketServer<T>(\r\n      options,\r\n      port,\r\n    );\r\n    this.assignServerToProperties(instance, observableServer.server);\r\n    this.subscribeEvents(instance, messageHandlers, observableServer);\r\n  }\r\n\r\n  public subscribeEvents(\r\n    instance: NestGateway,\r\n    subscribersMap: MessageMappingProperties[],\r\n    observableServer: ServerAndEventStreamsHost,\r\n  ) {\r\n    const { init, disconnect, connection, server } = observableServer;\r\n    const adapter = this.config.getIoAdapter();\r\n\r\n    this.subscribeInitEvent(instance, init);\r\n    this.subscribeConnectionEvent(instance, connection);\r\n    this.subscribeDisconnectEvent(instance, disconnect);\r\n\r\n    const handler = this.getConnectionHandler(\r\n      this,\r\n      instance,\r\n      subscribersMap,\r\n      disconnect,\r\n      connection,\r\n    );\r\n    adapter.bindClientConnect(server, handler);\r\n    this.printSubscriptionLogs(instance, subscribersMap);\r\n  }\r\n\r\n  public getConnectionHandler(\r\n    context: WebSocketsController,\r\n    instance: NestGateway,\r\n    subscribersMap: MessageMappingProperties[],\r\n    disconnect: Subject<any>,\r\n    connection: Subject<any>,\r\n  ) {\r\n    const adapter = this.config.getIoAdapter();\r\n    return (...args: unknown[]) => {\r\n      const [client] = args;\r\n      connection.next(args);\r\n      context.subscribeMessages(subscribersMap, client, instance);\r\n\r\n      const disconnectHook = adapter.bindClientDisconnect;\r\n      disconnectHook &&\r\n        disconnectHook.call(adapter, client, () => disconnect.next(client));\r\n    };\r\n  }\r\n\r\n  public subscribeInitEvent(instance: NestGateway, event: Subject<any>) {\r\n    if (instance.afterInit) {\r\n      event.subscribe(instance.afterInit.bind(instance));\r\n    }\r\n  }\r\n\r\n  public subscribeConnectionEvent(instance: NestGateway, event: Subject<any>) {\r\n    if (instance.handleConnection) {\r\n      event\r\n        .pipe(\r\n          distinctUntilChanged((prev, curr) => compareElementAt(prev, curr, 0)),\r\n        )\r\n        .subscribe((args: unknown[]) => instance.handleConnection(...args));\r\n    }\r\n  }\r\n\r\n  public subscribeDisconnectEvent(instance: NestGateway, event: Subject<any>) {\r\n    if (instance.handleDisconnect) {\r\n      event\r\n        .pipe(distinctUntilChanged())\r\n        .subscribe(instance.handleDisconnect.bind(instance));\r\n    }\r\n  }\r\n\r\n  public subscribeMessages<T = any>(\r\n    subscribersMap: MessageMappingProperties[],\r\n    client: T,\r\n    instance: NestGateway,\r\n  ) {\r\n    const adapter = this.config.getIoAdapter();\r\n    const handlers = subscribersMap.map(({ callback, message }) => ({\r\n      message,\r\n      callback: callback.bind(instance, client),\r\n    }));\r\n    adapter.bindMessageHandlers(client, handlers, data =>\r\n      fromPromise(this.pickResult(data)).pipe(mergeAll()),\r\n    );\r\n  }\r\n\r\n  public async pickResult(\r\n    deferredResult: Promise<any>,\r\n  ): Promise<Observable<any>> {\r\n    const result = await deferredResult;\r\n    if (isObservable(result)) {\r\n      return result;\r\n    }\r\n    if (result instanceof Promise) {\r\n      return fromPromise(result);\r\n    }\r\n    return of(result);\r\n  }\r\n\r\n  public inspectEntrypointDefinitions(\r\n    instance: NestGateway,\r\n    port: number,\r\n    messageHandlers: MessageMappingProperties[],\r\n    instanceWrapperId: string,\r\n  ) {\r\n    messageHandlers.forEach(handler => {\r\n      this.graphInspector.insertEntrypointDefinition<WebsocketEntrypointMetadata>(\r\n        {\r\n          type: 'websocket',\r\n          methodName: handler.methodName,\r\n          className: instance.constructor?.name,\r\n          classNodeId: instanceWrapperId,\r\n          metadata: {\r\n            port,\r\n            key: handler.message,\r\n            message: handler.message,\r\n          },\r\n        },\r\n        instanceWrapperId,\r\n      );\r\n    });\r\n  }\r\n\r\n  private assignServerToProperties<T = any>(\r\n    instance: NestGateway,\r\n    server: object,\r\n  ) {\r\n    for (const propertyKey of this.metadataExplorer.scanForServerHooks(\r\n      instance,\r\n    )) {\r\n      Reflect.set(instance, propertyKey, server);\r\n    }\r\n  }\r\n\r\n  private printSubscriptionLogs(\r\n    instance: NestGateway,\r\n    subscribersMap: MessageMappingProperties[],\r\n  ) {\r\n    const gatewayClassName = (instance as Object)?.constructor?.name;\r\n    if (!gatewayClassName) {\r\n      return;\r\n    }\r\n    subscribersMap.forEach(({ message }) =>\r\n      this.logger.log(\r\n        `${gatewayClassName} subscribed to the \"${message}\" message`,\r\n      ),\r\n    );\r\n  }\r\n}\r\n"]}