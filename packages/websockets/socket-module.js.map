{"version":3,"file":"socket-module.js","sourceRoot":"","sources":["socket-module.ts"],"names":[],"mappings":"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","sourcesContent":["import { InjectionToken } from '@nestjs/common/interfaces';\r\nimport { Injectable } from '@nestjs/common/interfaces/injectable.interface';\r\nimport { NestApplicationContextOptions } from '@nestjs/common/interfaces/nest-application-context-options.interface';\r\nimport { ApplicationConfig } from '@nestjs/core/application-config';\r\nimport { GuardsConsumer } from '@nestjs/core/guards/guards-consumer';\r\nimport { GuardsContextCreator } from '@nestjs/core/guards/guards-context-creator';\r\nimport { loadAdapter } from '@nestjs/core/helpers/load-adapter';\r\nimport { NestContainer } from '@nestjs/core/injector/container';\r\nimport { InstanceWrapper } from '@nestjs/core/injector/instance-wrapper';\r\nimport { GraphInspector } from '@nestjs/core/inspector/graph-inspector';\r\nimport { InterceptorsConsumer } from '@nestjs/core/interceptors/interceptors-consumer';\r\nimport { InterceptorsContextCreator } from '@nestjs/core/interceptors/interceptors-context-creator';\r\nimport { PipesConsumer } from '@nestjs/core/pipes/pipes-consumer';\r\nimport { PipesContextCreator } from '@nestjs/core/pipes/pipes-context-creator';\r\nimport { iterate } from 'iterare';\r\nimport { AbstractWsAdapter } from './adapters';\r\nimport { GATEWAY_METADATA } from './constants';\r\nimport { ExceptionFiltersContext } from './context/exception-filters-context';\r\nimport { WsContextCreator } from './context/ws-context-creator';\r\nimport { WsProxy } from './context/ws-proxy';\r\nimport { NestGateway } from './interfaces/nest-gateway.interface';\r\nimport { SocketServerProvider } from './socket-server-provider';\r\nimport { SocketsContainer } from './sockets-container';\r\nimport { WebSocketsController } from './web-sockets-controller';\r\n\r\nexport class SocketModule<\r\n  THttpServer = any,\r\n  TAppOptions extends NestApplicationContextOptions = NestApplicationContextOptions,\r\n> {\r\n  private readonly socketsContainer = new SocketsContainer();\r\n  private applicationConfig: ApplicationConfig;\r\n  private webSocketsController: WebSocketsController;\r\n  private isAdapterInitialized: boolean;\r\n  private httpServer: THttpServer | undefined;\r\n  private appOptions: TAppOptions;\r\n\r\n  public register(\r\n    container: NestContainer,\r\n    applicationConfig: ApplicationConfig,\r\n    graphInspector: GraphInspector,\r\n    appOptions: TAppOptions,\r\n    httpServer?: THttpServer,\r\n  ) {\r\n    this.applicationConfig = applicationConfig;\r\n    this.appOptions = appOptions;\r\n    this.httpServer = httpServer;\r\n\r\n    const contextCreator = this.getContextCreator(container);\r\n    const serverProvider = new SocketServerProvider(\r\n      this.socketsContainer,\r\n      applicationConfig,\r\n    );\r\n    this.webSocketsController = new WebSocketsController(\r\n      serverProvider,\r\n      applicationConfig,\r\n      contextCreator,\r\n      graphInspector,\r\n      this.appOptions,\r\n    );\r\n    const modules = container.getModules();\r\n    modules.forEach(({ providers }, moduleName: string) =>\r\n      this.connectAllGateways(providers, moduleName),\r\n    );\r\n  }\r\n\r\n  public connectAllGateways(\r\n    providers: Map<InjectionToken, InstanceWrapper<Injectable>>,\r\n    moduleName: string,\r\n  ) {\r\n    iterate(providers.values())\r\n      .filter(wrapper => wrapper && !wrapper.isNotMetatype)\r\n      .forEach(wrapper => this.connectGatewayToServer(wrapper, moduleName));\r\n  }\r\n\r\n  public connectGatewayToServer(\r\n    wrapper: InstanceWrapper<Injectable>,\r\n    moduleName: string,\r\n  ) {\r\n    const { instance, metatype } = wrapper;\r\n    const metadataKeys = Reflect.getMetadataKeys(metatype);\r\n    if (!metadataKeys.includes(GATEWAY_METADATA)) {\r\n      return;\r\n    }\r\n    if (!this.isAdapterInitialized) {\r\n      this.initializeAdapter();\r\n    }\r\n    this.webSocketsController.connectGatewayToServer(\r\n      instance as NestGateway,\r\n      metatype,\r\n      moduleName,\r\n      wrapper.id,\r\n    );\r\n  }\r\n\r\n  public async close(): Promise<any> {\r\n    if (!this.applicationConfig) {\r\n      return;\r\n    }\r\n    const adapter = this.applicationConfig.getIoAdapter();\r\n    if (!adapter) {\r\n      return;\r\n    }\r\n    const servers = this.socketsContainer.getAll();\r\n    await Promise.all(\r\n      iterate(servers.values())\r\n        .filter(({ server }) => server)\r\n        .map(async ({ server }) => adapter.close(server)),\r\n    );\r\n    await (adapter as AbstractWsAdapter)?.dispose();\r\n\r\n    this.socketsContainer.clear();\r\n  }\r\n\r\n  private initializeAdapter() {\r\n    const adapter = this.applicationConfig.getIoAdapter();\r\n    if (adapter) {\r\n      this.isAdapterInitialized = true;\r\n      return;\r\n    }\r\n    const { IoAdapter } = loadAdapter(\r\n      '@nestjs/platform-socket.io',\r\n      'WebSockets',\r\n      () => require('@nestjs/platform-socket.io'),\r\n    );\r\n    const ioAdapter = new IoAdapter(this.httpServer);\r\n    this.applicationConfig.setIoAdapter(ioAdapter);\r\n\r\n    this.isAdapterInitialized = true;\r\n  }\r\n\r\n  private getContextCreator(container: NestContainer): WsContextCreator {\r\n    return new WsContextCreator(\r\n      new WsProxy(),\r\n      new ExceptionFiltersContext(container),\r\n      new PipesContextCreator(container),\r\n      new PipesConsumer(),\r\n      new GuardsContextCreator(container),\r\n      new GuardsConsumer(),\r\n      new InterceptorsContextCreator(container),\r\n      new InterceptorsConsumer(),\r\n    );\r\n  }\r\n}\r\n"]}