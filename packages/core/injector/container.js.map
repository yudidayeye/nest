{"version":3,"file":"container.js","sourceRoot":"D:/04-learn-font/learn-node/nest/packages/core/","sources":["injector/container.ts"],"names":[],"mappings":"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","sourcesContent":["import { DynamicModule, Provider } from '@nestjs/common';\r\nimport {\r\n  EnhancerSubtype,\r\n  GLOBAL_MODULE_METADATA,\r\n} from '@nestjs/common/constants';\r\nimport { Injectable, Type } from '@nestjs/common/interfaces';\r\nimport { ApplicationConfig } from '../application-config';\r\nimport {\r\n  CircularDependencyException,\r\n  UndefinedForwardRefException,\r\n  UnknownModuleException,\r\n} from '../errors/exceptions';\r\nimport { InitializeOnPreviewAllowlist } from '../inspector/initialize-on-preview.allowlist';\r\nimport { SerializedGraph } from '../inspector/serialized-graph';\r\nimport { REQUEST } from '../router/request/request-constants';\r\nimport { ModuleCompiler, ModuleFactory } from './compiler';\r\nimport { ContextId } from './instance-wrapper';\r\nimport { InternalCoreModule } from './internal-core-module/internal-core-module';\r\nimport { InternalProvidersStorage } from './internal-providers-storage';\r\nimport { Module } from './module';\r\nimport { ModuleTokenFactory } from './module-token-factory';\r\nimport { ModulesContainer } from './modules-container';\r\n\r\ntype ModuleMetatype = Type<any> | DynamicModule | Promise<DynamicModule>;\r\ntype ModuleScope = Type<any>[];\r\n\r\nexport class NestContainer {\r\n  private readonly globalModules = new Set<Module>();\r\n  private readonly moduleTokenFactory = new ModuleTokenFactory();\r\n  private readonly moduleCompiler = new ModuleCompiler(this.moduleTokenFactory);\r\n  private readonly modules = new ModulesContainer();\r\n  private readonly dynamicModulesMetadata = new Map<\r\n    string,\r\n    Partial<DynamicModule>\r\n  >();\r\n  private readonly internalProvidersStorage = new InternalProvidersStorage();\r\n  private readonly _serializedGraph = new SerializedGraph();\r\n  private internalCoreModule: Module;\r\n\r\n  constructor(\r\n    private readonly _applicationConfig: ApplicationConfig = undefined,\r\n  ) {}\r\n\r\n  get serializedGraph(): SerializedGraph {\r\n    return this._serializedGraph;\r\n  }\r\n\r\n  get applicationConfig(): ApplicationConfig | undefined {\r\n    return this._applicationConfig;\r\n  }\r\n\r\n  public setHttpAdapter(httpAdapter: any) {\r\n    this.internalProvidersStorage.httpAdapter = httpAdapter;\r\n\r\n    if (!this.internalProvidersStorage.httpAdapterHost) {\r\n      return;\r\n    }\r\n    const host = this.internalProvidersStorage.httpAdapterHost;\r\n    host.httpAdapter = httpAdapter;\r\n  }\r\n\r\n  public getHttpAdapterRef() {\r\n    return this.internalProvidersStorage.httpAdapter;\r\n  }\r\n\r\n  public getHttpAdapterHostRef() {\r\n    return this.internalProvidersStorage.httpAdapterHost;\r\n  }\r\n\r\n  public async addModule(\r\n    metatype: ModuleMetatype,\r\n    scope: ModuleScope,\r\n  ): Promise<\r\n    | {\r\n        moduleRef: Module;\r\n        inserted: boolean;\r\n      }\r\n    | undefined\r\n  > {\r\n    // In DependenciesScanner#scanForModules we already check for undefined or invalid modules\r\n    // We still need to catch the edge-case of `forwardRef(() => undefined)`\r\n    if (!metatype) {\r\n      throw new UndefinedForwardRefException(scope);\r\n    }\r\n    const { type, dynamicMetadata, token } = await this.moduleCompiler.compile(\r\n      metatype,\r\n    );\r\n    if (this.modules.has(token)) {\r\n      return {\r\n        moduleRef: this.modules.get(token),\r\n        inserted: true,\r\n      };\r\n    }\r\n\r\n    return {\r\n      moduleRef: await this.setModule(\r\n        {\r\n          token,\r\n          type,\r\n          dynamicMetadata,\r\n        },\r\n        scope,\r\n      ),\r\n      inserted: true,\r\n    };\r\n  }\r\n\r\n  public async replaceModule(\r\n    metatypeToReplace: ModuleMetatype,\r\n    newMetatype: ModuleMetatype,\r\n    scope: ModuleScope,\r\n  ): Promise<\r\n    | {\r\n        moduleRef: Module;\r\n        inserted: boolean;\r\n      }\r\n    | undefined\r\n  > {\r\n    // In DependenciesScanner#scanForModules we already check for undefined or invalid modules\r\n    // We still need to catch the edge-case of `forwardRef(() => undefined)`\r\n    if (!metatypeToReplace || !newMetatype) {\r\n      throw new UndefinedForwardRefException(scope);\r\n    }\r\n\r\n    const { token } = await this.moduleCompiler.compile(metatypeToReplace);\r\n    const { type, dynamicMetadata } = await this.moduleCompiler.compile(\r\n      newMetatype,\r\n    );\r\n\r\n    return {\r\n      moduleRef: await this.setModule(\r\n        {\r\n          token,\r\n          type,\r\n          dynamicMetadata,\r\n        },\r\n        scope,\r\n      ),\r\n      inserted: false,\r\n    };\r\n  }\r\n\r\n  private async setModule(\r\n    { token, dynamicMetadata, type }: ModuleFactory,\r\n    scope: ModuleScope,\r\n  ): Promise<Module | undefined> {\r\n    const moduleRef = new Module(type, this);\r\n    moduleRef.token = token;\r\n    moduleRef.initOnPreview = this.shouldInitOnPreview(type);\r\n    this.modules.set(token, moduleRef);\r\n\r\n    const updatedScope = [].concat(scope, type);\r\n    await this.addDynamicMetadata(token, dynamicMetadata, updatedScope);\r\n\r\n    if (this.isGlobalModule(type, dynamicMetadata)) {\r\n      moduleRef.isGlobal = true;\r\n      this.addGlobalModule(moduleRef);\r\n    }\r\n\r\n    return moduleRef;\r\n  }\r\n\r\n  public async addDynamicMetadata(\r\n    token: string,\r\n    dynamicModuleMetadata: Partial<DynamicModule>,\r\n    scope: Type<any>[],\r\n  ) {\r\n    if (!dynamicModuleMetadata) {\r\n      return;\r\n    }\r\n    this.dynamicModulesMetadata.set(token, dynamicModuleMetadata);\r\n\r\n    const { imports } = dynamicModuleMetadata;\r\n    await this.addDynamicModules(imports, scope);\r\n  }\r\n\r\n  public async addDynamicModules(modules: any[], scope: Type<any>[]) {\r\n    if (!modules) {\r\n      return;\r\n    }\r\n    await Promise.all(modules.map(module => this.addModule(module, scope)));\r\n  }\r\n\r\n  public isGlobalModule(\r\n    metatype: Type<any>,\r\n    dynamicMetadata?: Partial<DynamicModule>,\r\n  ): boolean {\r\n    if (dynamicMetadata && dynamicMetadata.global) {\r\n      return true;\r\n    }\r\n    return !!Reflect.getMetadata(GLOBAL_MODULE_METADATA, metatype);\r\n  }\r\n\r\n  public addGlobalModule(module: Module) {\r\n    this.globalModules.add(module);\r\n  }\r\n\r\n  public getModules(): ModulesContainer {\r\n    return this.modules;\r\n  }\r\n\r\n  public getModuleCompiler(): ModuleCompiler {\r\n    return this.moduleCompiler;\r\n  }\r\n\r\n  public getModuleByKey(moduleKey: string): Module {\r\n    return this.modules.get(moduleKey);\r\n  }\r\n\r\n  public getInternalCoreModuleRef(): Module | undefined {\r\n    return this.internalCoreModule;\r\n  }\r\n\r\n  public async addImport(\r\n    relatedModule: Type<any> | DynamicModule,\r\n    token: string,\r\n  ) {\r\n    if (!this.modules.has(token)) {\r\n      return;\r\n    }\r\n    const moduleRef = this.modules.get(token);\r\n    const { token: relatedModuleToken } = await this.moduleCompiler.compile(\r\n      relatedModule,\r\n    );\r\n    const related = this.modules.get(relatedModuleToken);\r\n    moduleRef.addRelatedModule(related);\r\n  }\r\n\r\n  public addProvider(\r\n    provider: Provider,\r\n    token: string,\r\n    enhancerSubtype?: EnhancerSubtype,\r\n  ): string | symbol | Function {\r\n    const moduleRef = this.modules.get(token);\r\n    if (!provider) {\r\n      throw new CircularDependencyException(moduleRef?.metatype.name);\r\n    }\r\n    if (!moduleRef) {\r\n      throw new UnknownModuleException();\r\n    }\r\n    return moduleRef.addProvider(provider, enhancerSubtype) as Function;\r\n  }\r\n\r\n  public addInjectable(\r\n    injectable: Provider,\r\n    token: string,\r\n    enhancerSubtype: EnhancerSubtype,\r\n    host?: Type<Injectable>,\r\n  ) {\r\n    if (!this.modules.has(token)) {\r\n      throw new UnknownModuleException();\r\n    }\r\n    const moduleRef = this.modules.get(token);\r\n    return moduleRef.addInjectable(injectable, enhancerSubtype, host);\r\n  }\r\n\r\n  public addExportedProvider(provider: Type<any>, token: string) {\r\n    if (!this.modules.has(token)) {\r\n      throw new UnknownModuleException();\r\n    }\r\n    const moduleRef = this.modules.get(token);\r\n    moduleRef.addExportedProvider(provider);\r\n  }\r\n\r\n  public addController(controller: Type<any>, token: string) {\r\n    if (!this.modules.has(token)) {\r\n      throw new UnknownModuleException();\r\n    }\r\n    const moduleRef = this.modules.get(token);\r\n    moduleRef.addController(controller);\r\n  }\r\n\r\n  public clear() {\r\n    this.modules.clear();\r\n  }\r\n\r\n  public replace(toReplace: any, options: any & { scope: any[] | null }) {\r\n    this.modules.forEach(moduleRef => moduleRef.replace(toReplace, options));\r\n  }\r\n\r\n  public bindGlobalScope() {\r\n    this.modules.forEach(moduleRef => this.bindGlobalsToImports(moduleRef));\r\n  }\r\n\r\n  public bindGlobalsToImports(moduleRef: Module) {\r\n    this.globalModules.forEach(globalModule =>\r\n      this.bindGlobalModuleToModule(moduleRef, globalModule),\r\n    );\r\n  }\r\n\r\n  public bindGlobalModuleToModule(target: Module, globalModule: Module) {\r\n    if (target === globalModule || target === this.internalCoreModule) {\r\n      return;\r\n    }\r\n    target.addRelatedModule(globalModule);\r\n  }\r\n\r\n  public getDynamicMetadataByToken(token: string): Partial<DynamicModule>;\r\n  public getDynamicMetadataByToken<\r\n    K extends Exclude<keyof DynamicModule, 'global' | 'module'>,\r\n  >(token: string, metadataKey: K): DynamicModule[K];\r\n  public getDynamicMetadataByToken(\r\n    token: string,\r\n    metadataKey?: Exclude<keyof DynamicModule, 'global' | 'module'>,\r\n  ) {\r\n    const metadata = this.dynamicModulesMetadata.get(token);\r\n    return metadataKey ? metadata?.[metadataKey] ?? [] : metadata;\r\n  }\r\n\r\n  public registerCoreModuleRef(moduleRef: Module) {\r\n    this.internalCoreModule = moduleRef;\r\n    this.modules[InternalCoreModule.name] = moduleRef;\r\n  }\r\n\r\n  public getModuleTokenFactory(): ModuleTokenFactory {\r\n    return this.moduleTokenFactory;\r\n  }\r\n\r\n  public registerRequestProvider<T = any>(request: T, contextId: ContextId) {\r\n    const wrapper = this.internalCoreModule.getProviderByKey(REQUEST);\r\n    wrapper.setInstanceByContextId(contextId, {\r\n      instance: request,\r\n      isResolved: true,\r\n    });\r\n  }\r\n\r\n  private shouldInitOnPreview(type: Type) {\r\n    return InitializeOnPreviewAllowlist.has(type);\r\n  }\r\n}\r\n"]}