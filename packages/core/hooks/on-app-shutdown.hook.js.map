{"version":3,"file":"on-app-shutdown.hook.js","sourceRoot":"D:/04-learn-font/learn-node/nest/packages/core/","sources":["hooks/on-app-shutdown.hook.ts"],"names":[],"mappings":";;;AACA,oEAAsE;AACtE,qCAAkC;AAClC,iFAGiD;AAIjD;;;;GAIG;AACH,SAAS,oBAAoB,CAC3B,QAAiB;IAEjB,OAAO,IAAA,yBAAU,EAAE,QAAkC,CAAC,qBAAqB,CAAC,CAAC;AAC/E,CAAC;AAED;;GAEG;AACH,SAAS,YAAY,CACnB,SAA4B,EAC5B,MAAe;IAEf,OAAO,IAAA,iBAAO,EAAC,SAAS,CAAC;SACtB,MAAM,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,IAAA,oBAAK,EAAC,QAAQ,CAAC,CAAC;SACpC,MAAM,CAAC,oBAAoB,CAAC;SAC5B,GAAG,CAAC,KAAK,EAAC,QAAQ,EAAC,EAAE,CACnB,QAAyC,CAAC,qBAAqB,CAAC,MAAM,CAAC,CACzE;SACA,OAAO,EAAE,CAAC;AACf,CAAC;AAED;;;;;GAKG;AACI,KAAK,UAAU,mBAAmB,CACvC,MAAc,EACd,MAAe;IAEf,MAAM,SAAS,GAAG,MAAM,CAAC,oBAAoB,EAAE,CAAC;IAChD,sEAAsE;IACtE,4EAA4E;IAC5E,MAAM,CAAC,CAAC,EAAE,eAAe,CAAC,GAAG,SAAS,CAAC,KAAK,EAAE,CAAC;IAC/C,MAAM,SAAS,GAAG;QAChB,GAAG,MAAM,CAAC,WAAW;QACrB,GAAG,SAAS;QACZ,GAAG,MAAM,CAAC,WAAW;QACrB,GAAG,MAAM,CAAC,WAAW;KACtB,CAAC;IAEF,MAAM,qBAAqB,GAAG,IAAA,8CAAwB,EAAC,SAAS,CAAC,CAAC;IAClE,MAAM,OAAO,CAAC,GAAG,CAAC,YAAY,CAAC,qBAAqB,EAAE,MAAM,CAAC,CAAC,CAAC;IAC/D,MAAM,kBAAkB,GAAG,IAAA,2CAAqB,EAAC,SAAS,CAAC,CAAC;IAC5D,MAAM,OAAO,CAAC,GAAG,CAAC,YAAY,CAAC,kBAAkB,EAAE,MAAM,CAAC,CAAC,CAAC;IAE5D,2BAA2B;IAC3B,MAAM,mBAAmB,GAAG,eAAe,CAAC,QAAQ,CAAC;IACrD,IACE,mBAAmB;QACnB,oBAAoB,CAAC,mBAAmB,CAAC;QACzC,eAAe,CAAC,sBAAsB,EAAE,EACxC;QACA,MAAO,mBAA6C,CAAC,qBAAqB,CACxE,MAAM,CACP,CAAC;KACH;AACH,CAAC;AA/BD,kDA+BC","sourcesContent":["import { OnApplicationShutdown } from '@nestjs/common';\r\nimport { isFunction, isNil } from '@nestjs/common/utils/shared.utils';\r\nimport { iterate } from 'iterare';\r\nimport {\r\n  getNonTransientInstances,\r\n  getTransientInstances,\r\n} from '../injector/helpers/transient-instances';\r\nimport { InstanceWrapper } from '../injector/instance-wrapper';\r\nimport { Module } from '../injector/module';\r\n\r\n/**\r\n * Checks if the given instance has the `onApplicationShutdown` function\r\n *\r\n * @param instance The instance which should be checked\r\n */\r\nfunction hasOnAppShutdownHook(\r\n  instance: unknown,\r\n): instance is OnApplicationShutdown {\r\n  return isFunction((instance as OnApplicationShutdown).onApplicationShutdown);\r\n}\r\n\r\n/**\r\n * Calls the given instances\r\n */\r\nfunction callOperator(\r\n  instances: InstanceWrapper[],\r\n  signal?: string,\r\n): Promise<any>[] {\r\n  return iterate(instances)\r\n    .filter(instance => !isNil(instance))\r\n    .filter(hasOnAppShutdownHook)\r\n    .map(async instance =>\r\n      (instance as any as OnApplicationShutdown).onApplicationShutdown(signal),\r\n    )\r\n    .toArray();\r\n}\r\n\r\n/**\r\n * Calls the `onApplicationShutdown` function on the module and its children\r\n * (providers / controllers).\r\n *\r\n * @param module The module which will be initialized\r\n */\r\nexport async function callAppShutdownHook(\r\n  module: Module,\r\n  signal?: string,\r\n): Promise<any> {\r\n  const providers = module.getNonAliasProviders();\r\n  // Module (class) instance is the first element of the providers array\r\n  // Lifecycle hook has to be called once all classes are properly initialized\r\n  const [_, moduleClassHost] = providers.shift();\r\n  const instances = [\r\n    ...module.controllers,\r\n    ...providers,\r\n    ...module.injectables,\r\n    ...module.middlewares,\r\n  ];\r\n\r\n  const nonTransientInstances = getNonTransientInstances(instances);\r\n  await Promise.all(callOperator(nonTransientInstances, signal));\r\n  const transientInstances = getTransientInstances(instances);\r\n  await Promise.all(callOperator(transientInstances, signal));\r\n\r\n  // Call the instance itself\r\n  const moduleClassInstance = moduleClassHost.instance;\r\n  if (\r\n    moduleClassInstance &&\r\n    hasOnAppShutdownHook(moduleClassInstance) &&\r\n    moduleClassHost.isDependencyTreeStatic()\r\n  ) {\r\n    await (moduleClassInstance as OnApplicationShutdown).onApplicationShutdown(\r\n      signal,\r\n    );\r\n  }\r\n}\r\n"]}