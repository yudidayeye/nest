{"version":3,"file":"pipes-context-creator.js","sourceRoot":"D:/04-learn-font/learn-node/nest/packages/core/","sources":["pipes/pipes-context-creator.ts"],"names":[],"mappings":"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","sourcesContent":["import { PIPES_METADATA } from '@nestjs/common/constants';\r\nimport { Controller, PipeTransform, Type } from '@nestjs/common/interfaces';\r\nimport { isEmpty, isFunction } from '@nestjs/common/utils/shared.utils';\r\nimport { iterate } from 'iterare';\r\nimport { ApplicationConfig } from '../application-config';\r\nimport { ContextCreator } from '../helpers/context-creator';\r\nimport { STATIC_CONTEXT } from '../injector/constants';\r\nimport { NestContainer } from '../injector/container';\r\nimport { InstanceWrapper } from '../injector/instance-wrapper';\r\n\r\nexport class PipesContextCreator extends ContextCreator {\r\n  private moduleContext: string;\r\n\r\n  constructor(\r\n    private readonly container: NestContainer,\r\n    private readonly config?: ApplicationConfig,\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  public create(\r\n    instance: Controller,\r\n    callback: (...args: unknown[]) => unknown,\r\n    moduleKey: string,\r\n    contextId = STATIC_CONTEXT,\r\n    inquirerId?: string,\r\n  ): PipeTransform[] {\r\n    this.moduleContext = moduleKey;\r\n    return this.createContext(\r\n      instance,\r\n      callback,\r\n      PIPES_METADATA,\r\n      contextId,\r\n      inquirerId,\r\n    );\r\n  }\r\n\r\n  public createConcreteContext<T extends any[], R extends any[]>(\r\n    metadata: T,\r\n    contextId = STATIC_CONTEXT,\r\n    inquirerId?: string,\r\n  ): R {\r\n    if (isEmpty(metadata)) {\r\n      return [] as R;\r\n    }\r\n    return iterate(metadata)\r\n      .filter((pipe: any) => pipe && (pipe.name || pipe.transform))\r\n      .map(pipe => this.getPipeInstance(pipe, contextId, inquirerId))\r\n      .filter(pipe => pipe && pipe.transform && isFunction(pipe.transform))\r\n      .toArray() as R;\r\n  }\r\n\r\n  public getPipeInstance(\r\n    pipe: Function | PipeTransform,\r\n    contextId = STATIC_CONTEXT,\r\n    inquirerId?: string,\r\n  ): PipeTransform | null {\r\n    const isObject = (pipe as PipeTransform).transform;\r\n    if (isObject) {\r\n      return pipe as PipeTransform;\r\n    }\r\n    const instanceWrapper = this.getInstanceByMetatype(pipe as Type<unknown>);\r\n    if (!instanceWrapper) {\r\n      return null;\r\n    }\r\n    const instanceHost = instanceWrapper.getInstanceByContextId(\r\n      this.getContextId(contextId, instanceWrapper),\r\n      inquirerId,\r\n    );\r\n    return instanceHost && instanceHost.instance;\r\n  }\r\n\r\n  public getInstanceByMetatype(\r\n    metatype: Type<unknown>,\r\n  ): InstanceWrapper | undefined {\r\n    if (!this.moduleContext) {\r\n      return;\r\n    }\r\n    const collection = this.container.getModules();\r\n    const moduleRef = collection.get(this.moduleContext);\r\n    if (!moduleRef) {\r\n      return;\r\n    }\r\n    return moduleRef.injectables.get(metatype);\r\n  }\r\n\r\n  public getGlobalMetadata<T extends unknown[]>(\r\n    contextId = STATIC_CONTEXT,\r\n    inquirerId?: string,\r\n  ): T {\r\n    if (!this.config) {\r\n      return [] as T;\r\n    }\r\n    const globalPipes = this.config.getGlobalPipes() as T;\r\n    if (contextId === STATIC_CONTEXT && !inquirerId) {\r\n      return globalPipes;\r\n    }\r\n    const scopedPipeWrappers =\r\n      this.config.getGlobalRequestPipes() as InstanceWrapper[];\r\n    const scopedPipes = iterate(scopedPipeWrappers)\r\n      .map(wrapper =>\r\n        wrapper.getInstanceByContextId(\r\n          this.getContextId(contextId, wrapper),\r\n          inquirerId,\r\n        ),\r\n      )\r\n      .filter(host => !!host)\r\n      .map(host => host.instance)\r\n      .toArray();\r\n\r\n    return globalPipes.concat(scopedPipes) as T;\r\n  }\r\n\r\n  public setModuleContext(context: string) {\r\n    this.moduleContext = context;\r\n  }\r\n}\r\n"]}