{"version":3,"file":"external-context-creator.js","sourceRoot":"D:/04-learn-font/learn-node/nest/packages/core/","sources":["helpers/external-context-creator.ts"],"names":[],"mappings":"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","sourcesContent":["import { ForbiddenException, ParamData } from '@nestjs/common';\r\nimport { CUSTOM_ROUTE_ARGS_METADATA } from '@nestjs/common/constants';\r\nimport {\r\n  ContextType,\r\n  Controller,\r\n  PipeTransform,\r\n} from '@nestjs/common/interfaces';\r\nimport { isEmpty } from '@nestjs/common/utils/shared.utils';\r\nimport { lastValueFrom, isObservable } from 'rxjs';\r\nimport { ExternalExceptionFilterContext } from '../exceptions/external-exception-filter-context';\r\nimport { FORBIDDEN_MESSAGE } from '../guards/constants';\r\nimport { GuardsConsumer, GuardsContextCreator } from '../guards';\r\nimport { STATIC_CONTEXT } from '../injector/constants';\r\nimport { NestContainer } from '../injector/container';\r\nimport { ContextId } from '../injector/instance-wrapper';\r\nimport { ModulesContainer } from '../injector/modules-container';\r\nimport {\r\n  InterceptorsConsumer,\r\n  InterceptorsContextCreator,\r\n} from '../interceptors';\r\nimport { PipesConsumer, PipesContextCreator } from '../pipes';\r\nimport { ContextUtils, ParamProperties } from './context-utils';\r\nimport { ExternalErrorProxy } from './external-proxy';\r\nimport { HandlerMetadataStorage } from './handler-metadata-storage';\r\nimport { ExternalHandlerMetadata } from './interfaces/external-handler-metadata.interface';\r\nimport { ParamsMetadata } from './interfaces/params-metadata.interface';\r\n\r\nexport interface ParamsFactory {\r\n  exchangeKeyForValue(type: number, data: ParamData, args: any): any;\r\n}\r\n\r\nexport interface ExternalContextOptions {\r\n  guards?: boolean;\r\n  interceptors?: boolean;\r\n  filters?: boolean;\r\n}\r\n\r\nexport class ExternalContextCreator {\r\n  private readonly contextUtils = new ContextUtils();\r\n  private readonly externalErrorProxy = new ExternalErrorProxy();\r\n  private readonly handlerMetadataStorage =\r\n    new HandlerMetadataStorage<ExternalHandlerMetadata>();\r\n  private container: NestContainer;\r\n\r\n  constructor(\r\n    private readonly guardsContextCreator: GuardsContextCreator,\r\n    private readonly guardsConsumer: GuardsConsumer,\r\n    private readonly interceptorsContextCreator: InterceptorsContextCreator,\r\n    private readonly interceptorsConsumer: InterceptorsConsumer,\r\n    private readonly modulesContainer: ModulesContainer,\r\n    private readonly pipesContextCreator: PipesContextCreator,\r\n    private readonly pipesConsumer: PipesConsumer,\r\n    private readonly filtersContextCreator: ExternalExceptionFilterContext,\r\n  ) {}\r\n\r\n  static fromContainer(container: NestContainer): ExternalContextCreator {\r\n    const guardsContextCreator = new GuardsContextCreator(\r\n      container,\r\n      container.applicationConfig,\r\n    );\r\n    const guardsConsumer = new GuardsConsumer();\r\n    const interceptorsContextCreator = new InterceptorsContextCreator(\r\n      container,\r\n      container.applicationConfig,\r\n    );\r\n    const interceptorsConsumer = new InterceptorsConsumer();\r\n    const pipesContextCreator = new PipesContextCreator(\r\n      container,\r\n      container.applicationConfig,\r\n    );\r\n    const pipesConsumer = new PipesConsumer();\r\n    const filtersContextCreator = new ExternalExceptionFilterContext(\r\n      container,\r\n      container.applicationConfig,\r\n    );\r\n\r\n    const externalContextCreator = new ExternalContextCreator(\r\n      guardsContextCreator,\r\n      guardsConsumer,\r\n      interceptorsContextCreator,\r\n      interceptorsConsumer,\r\n      container.getModules(),\r\n      pipesContextCreator,\r\n      pipesConsumer,\r\n      filtersContextCreator,\r\n    );\r\n    externalContextCreator.container = container;\r\n    return externalContextCreator;\r\n  }\r\n\r\n  public create<\r\n    TParamsMetadata extends ParamsMetadata = ParamsMetadata,\r\n    TContext extends string = ContextType,\r\n  >(\r\n    instance: Controller,\r\n    callback: (...args: unknown[]) => unknown,\r\n    methodName: string,\r\n    metadataKey?: string,\r\n    paramsFactory?: ParamsFactory,\r\n    contextId = STATIC_CONTEXT,\r\n    inquirerId?: string,\r\n    options: ExternalContextOptions = {\r\n      interceptors: true,\r\n      guards: true,\r\n      filters: true,\r\n    },\r\n    contextType: TContext = 'http' as TContext,\r\n  ) {\r\n    const module = this.getContextModuleKey(instance.constructor);\r\n    const { argsLength, paramtypes, getParamsMetadata } = this.getMetadata<\r\n      TParamsMetadata,\r\n      TContext\r\n    >(instance, methodName, metadataKey, paramsFactory, contextType);\r\n    const pipes = this.pipesContextCreator.create(\r\n      instance,\r\n      callback,\r\n      module,\r\n      contextId,\r\n      inquirerId,\r\n    );\r\n    const guards = this.guardsContextCreator.create(\r\n      instance,\r\n      callback,\r\n      module,\r\n      contextId,\r\n      inquirerId,\r\n    );\r\n    const exceptionFilter = this.filtersContextCreator.create(\r\n      instance,\r\n      callback,\r\n      module,\r\n      contextId,\r\n      inquirerId,\r\n    );\r\n    const interceptors = options.interceptors\r\n      ? this.interceptorsContextCreator.create(\r\n          instance,\r\n          callback,\r\n          module,\r\n          contextId,\r\n          inquirerId,\r\n        )\r\n      : [];\r\n\r\n    const paramsMetadata = getParamsMetadata(module, contextId, inquirerId);\r\n    const paramsOptions = paramsMetadata\r\n      ? this.contextUtils.mergeParamsMetatypes(paramsMetadata, paramtypes)\r\n      : [];\r\n\r\n    const fnCanActivate = options.guards\r\n      ? this.createGuardsFn(guards, instance, callback, contextType)\r\n      : null;\r\n    const fnApplyPipes = this.createPipesFn(pipes, paramsOptions);\r\n    const handler =\r\n      (initialArgs: unknown[], ...args: unknown[]) =>\r\n      async () => {\r\n        if (fnApplyPipes) {\r\n          await fnApplyPipes(initialArgs, ...args);\r\n          return callback.apply(instance, initialArgs);\r\n        }\r\n        return callback.apply(instance, args);\r\n      };\r\n\r\n    const target = async (...args: any[]) => {\r\n      const initialArgs = this.contextUtils.createNullArray(argsLength);\r\n      fnCanActivate && (await fnCanActivate(args));\r\n\r\n      const result = await this.interceptorsConsumer.intercept(\r\n        interceptors,\r\n        args,\r\n        instance,\r\n        callback,\r\n        handler(initialArgs, ...args),\r\n        contextType,\r\n      );\r\n      return this.transformToResult(result);\r\n    };\r\n    return options.filters\r\n      ? this.externalErrorProxy.createProxy(\r\n          target,\r\n          exceptionFilter,\r\n          contextType,\r\n        )\r\n      : target;\r\n  }\r\n\r\n  public getMetadata<TMetadata, TContext extends string = ContextType>(\r\n    instance: Controller,\r\n    methodName: string,\r\n    metadataKey?: string,\r\n    paramsFactory?: ParamsFactory,\r\n    contextType?: TContext,\r\n  ): ExternalHandlerMetadata {\r\n    const cacheMetadata = this.handlerMetadataStorage.get(instance, methodName);\r\n    if (cacheMetadata) {\r\n      return cacheMetadata;\r\n    }\r\n    const metadata =\r\n      this.contextUtils.reflectCallbackMetadata<TMetadata>(\r\n        instance,\r\n        methodName,\r\n        metadataKey || '',\r\n      ) || {};\r\n    const keys = Object.keys(metadata);\r\n    const argsLength = this.contextUtils.getArgumentsLength(keys, metadata);\r\n    const paramtypes = this.contextUtils.reflectCallbackParamtypes(\r\n      instance,\r\n      methodName,\r\n    );\r\n    const contextFactory = this.contextUtils.getContextFactory<TContext>(\r\n      contextType,\r\n      instance,\r\n      instance[methodName],\r\n    );\r\n    const getParamsMetadata = (\r\n      moduleKey: string,\r\n      contextId = STATIC_CONTEXT,\r\n      inquirerId?: string,\r\n    ) =>\r\n      paramsFactory\r\n        ? this.exchangeKeysForValues(\r\n            keys,\r\n            metadata,\r\n            moduleKey,\r\n            paramsFactory,\r\n            contextId,\r\n            inquirerId,\r\n            contextFactory,\r\n          )\r\n        : null;\r\n\r\n    const handlerMetadata: ExternalHandlerMetadata = {\r\n      argsLength,\r\n      paramtypes,\r\n      getParamsMetadata,\r\n    };\r\n    this.handlerMetadataStorage.set(instance, methodName, handlerMetadata);\r\n    return handlerMetadata;\r\n  }\r\n\r\n  public getContextModuleKey(moduleCtor: Function | undefined): string {\r\n    const emptyModuleKey = '';\r\n    if (!moduleCtor) {\r\n      return emptyModuleKey;\r\n    }\r\n    const moduleContainerEntries = this.modulesContainer.entries();\r\n    for (const [key, moduleRef] of moduleContainerEntries) {\r\n      if (moduleRef.hasProvider(moduleCtor)) {\r\n        return key;\r\n      }\r\n    }\r\n    return emptyModuleKey;\r\n  }\r\n\r\n  public exchangeKeysForValues<TMetadata = any>(\r\n    keys: string[],\r\n    metadata: TMetadata,\r\n    moduleContext: string,\r\n    paramsFactory: ParamsFactory,\r\n    contextId = STATIC_CONTEXT,\r\n    inquirerId?: string,\r\n    contextFactory = this.contextUtils.getContextFactory('http'),\r\n  ): ParamProperties[] {\r\n    this.pipesContextCreator.setModuleContext(moduleContext);\r\n\r\n    return keys.map(key => {\r\n      const { index, data, pipes: pipesCollection } = metadata[key];\r\n      const pipes = this.pipesContextCreator.createConcreteContext(\r\n        pipesCollection,\r\n        contextId,\r\n        inquirerId,\r\n      );\r\n      const type = this.contextUtils.mapParamType(key);\r\n\r\n      if (key.includes(CUSTOM_ROUTE_ARGS_METADATA)) {\r\n        const { factory } = metadata[key];\r\n        const customExtractValue = this.contextUtils.getCustomFactory(\r\n          factory,\r\n          data,\r\n          contextFactory,\r\n        );\r\n        return { index, extractValue: customExtractValue, type, data, pipes };\r\n      }\r\n      const numericType = Number(type);\r\n      const extractValue = (...args: unknown[]) =>\r\n        paramsFactory.exchangeKeyForValue(numericType, data, args);\r\n\r\n      return { index, extractValue, type: numericType, data, pipes };\r\n    });\r\n  }\r\n\r\n  public createPipesFn(\r\n    pipes: PipeTransform[],\r\n    paramsOptions: (ParamProperties & { metatype?: unknown })[],\r\n  ) {\r\n    const pipesFn = async (args: unknown[], ...params: unknown[]) => {\r\n      const resolveParamValue = async (\r\n        param: ParamProperties & { metatype?: unknown },\r\n      ) => {\r\n        const {\r\n          index,\r\n          extractValue,\r\n          type,\r\n          data,\r\n          metatype,\r\n          pipes: paramPipes,\r\n        } = param;\r\n        const value = extractValue(...params);\r\n\r\n        args[index] = await this.getParamValue(\r\n          value,\r\n          { metatype, type, data },\r\n          pipes.concat(paramPipes),\r\n        );\r\n      };\r\n      await Promise.all(paramsOptions.map(resolveParamValue));\r\n    };\r\n    return paramsOptions.length ? pipesFn : null;\r\n  }\r\n\r\n  public async getParamValue<T>(\r\n    value: T,\r\n    { metatype, type, data }: { metatype: any; type: any; data: any },\r\n    pipes: PipeTransform[],\r\n  ): Promise<any> {\r\n    return isEmpty(pipes)\r\n      ? value\r\n      : this.pipesConsumer.apply(value, { metatype, type, data }, pipes);\r\n  }\r\n\r\n  public async transformToResult(resultOrDeferred: any) {\r\n    if (isObservable(resultOrDeferred)) {\r\n      return lastValueFrom(resultOrDeferred);\r\n    }\r\n    return resultOrDeferred;\r\n  }\r\n\r\n  public createGuardsFn<TContext extends string = ContextType>(\r\n    guards: any[],\r\n    instance: Controller,\r\n    callback: (...args: any[]) => any,\r\n    contextType?: TContext,\r\n  ): Function | null {\r\n    const canActivateFn = async (args: any[]) => {\r\n      const canActivate = await this.guardsConsumer.tryActivate<TContext>(\r\n        guards,\r\n        args,\r\n        instance,\r\n        callback,\r\n        contextType,\r\n      );\r\n      if (!canActivate) {\r\n        throw new ForbiddenException(FORBIDDEN_MESSAGE);\r\n      }\r\n    };\r\n    return guards.length ? canActivateFn : null;\r\n  }\r\n\r\n  public registerRequestProvider<T = any>(request: T, contextId: ContextId) {\r\n    this.container.registerRequestProvider<T>(request, contextId);\r\n  }\r\n}\r\n"]}