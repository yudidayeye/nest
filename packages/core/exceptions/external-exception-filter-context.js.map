{"version":3,"file":"external-exception-filter-context.js","sourceRoot":"D:/04-learn-font/learn-node/nest/packages/core/","sources":["exceptions/external-exception-filter-context.ts"],"names":[],"mappings":";;;AAAA,wDAAsE;AAGtE,oEAA4D;AAE5D,qDAAuD;AAIvD,mFAA6E;AAC7E,+EAA0E;AAC1E,qCAAkC;AAElC,MAAa,8BAA+B,SAAQ,0DAA0B;IAC5E,YACE,SAAwB,EACP,MAA0B;QAE3C,KAAK,CAAC,SAAS,CAAC,CAAC;QAFA,WAAM,GAAN,MAAM,CAAoB;IAG7C,CAAC;IAEM,MAAM,CACX,QAAoB,EACpB,QAA6B,EAC7B,MAAc,EACd,SAAS,GAAG,0BAAc,EAC1B,UAAmB;QAEnB,IAAI,CAAC,aAAa,GAAG,MAAM,CAAC;QAE5B,MAAM,gBAAgB,GAAG,IAAI,uDAAyB,EAAE,CAAC;QACzD,MAAM,OAAO,GAAG,IAAI,CAAC,aAAa,CAChC,QAAQ,EACR,QAAQ,EACR,sCAA0B,EAC1B,SAAS,EACT,UAAU,CACX,CAAC;QACF,IAAI,IAAA,sBAAO,EAAC,OAAO,CAAC,EAAE;YACpB,OAAO,gBAAgB,CAAC;SACzB;QACD,gBAAgB,CAAC,gBAAgB,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC,CAAC;QACrD,OAAO,gBAAgB,CAAC;IAC1B,CAAC;IAEM,iBAAiB,CACtB,SAAS,GAAG,0BAAc,EAC1B,UAAmB;QAEnB,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE;YAChB,OAAO,EAAO,CAAC;SAChB;QACD,MAAM,aAAa,GAAG,IAAI,CAAC,MAAM,CAAC,gBAAgB,EAAO,CAAC;QAC1D,IAAI,SAAS,KAAK,0BAAc,IAAI,CAAC,UAAU,EAAE;YAC/C,OAAO,aAAa,CAAC;SACtB;QACD,MAAM,oBAAoB,GACxB,IAAI,CAAC,MAAM,CAAC,uBAAuB,EAAuB,CAAC;QAC7D,MAAM,aAAa,GAAG,IAAA,iBAAO,EAAC,oBAAoB,CAAC;aAChD,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,sBAAsB,CAAC,SAAS,EAAE,UAAU,CAAC,CAAC;aACrE,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC;aACtB,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC;aAC1B,OAAO,EAAE,CAAC;QAEb,OAAO,aAAa,CAAC,MAAM,CAAC,aAAa,CAAM,CAAC;IAClD,CAAC;CACF;AArDD,wEAqDC","sourcesContent":["import { EXCEPTION_FILTERS_METADATA } from '@nestjs/common/constants';\r\nimport { Controller } from '@nestjs/common/interfaces';\r\nimport { ExceptionFilterMetadata } from '@nestjs/common/interfaces/exceptions';\r\nimport { isEmpty } from '@nestjs/common/utils/shared.utils';\r\nimport { ApplicationConfig } from '../application-config';\r\nimport { STATIC_CONTEXT } from '../injector/constants';\r\nimport { NestContainer } from '../injector/container';\r\nimport { InstanceWrapper } from '../injector/instance-wrapper';\r\nimport { RouterProxyCallback } from '../router/router-proxy';\r\nimport { BaseExceptionFilterContext } from './base-exception-filter-context';\r\nimport { ExternalExceptionsHandler } from './external-exceptions-handler';\r\nimport { iterate } from 'iterare';\r\n\r\nexport class ExternalExceptionFilterContext extends BaseExceptionFilterContext {\r\n  constructor(\r\n    container: NestContainer,\r\n    private readonly config?: ApplicationConfig,\r\n  ) {\r\n    super(container);\r\n  }\r\n\r\n  public create(\r\n    instance: Controller,\r\n    callback: RouterProxyCallback,\r\n    module: string,\r\n    contextId = STATIC_CONTEXT,\r\n    inquirerId?: string,\r\n  ): ExternalExceptionsHandler {\r\n    this.moduleContext = module;\r\n\r\n    const exceptionHandler = new ExternalExceptionsHandler();\r\n    const filters = this.createContext<ExceptionFilterMetadata[]>(\r\n      instance,\r\n      callback,\r\n      EXCEPTION_FILTERS_METADATA,\r\n      contextId,\r\n      inquirerId,\r\n    );\r\n    if (isEmpty(filters)) {\r\n      return exceptionHandler;\r\n    }\r\n    exceptionHandler.setCustomFilters(filters.reverse());\r\n    return exceptionHandler;\r\n  }\r\n\r\n  public getGlobalMetadata<T extends any[]>(\r\n    contextId = STATIC_CONTEXT,\r\n    inquirerId?: string,\r\n  ): T {\r\n    if (!this.config) {\r\n      return [] as T;\r\n    }\r\n    const globalFilters = this.config.getGlobalFilters() as T;\r\n    if (contextId === STATIC_CONTEXT && !inquirerId) {\r\n      return globalFilters;\r\n    }\r\n    const scopedFilterWrappers =\r\n      this.config.getGlobalRequestFilters() as InstanceWrapper[];\r\n    const scopedFilters = iterate(scopedFilterWrappers)\r\n      .map(wrapper => wrapper.getInstanceByContextId(contextId, inquirerId))\r\n      .filter(host => !!host)\r\n      .map(host => host.instance)\r\n      .toArray();\r\n\r\n    return globalFilters.concat(scopedFilters) as T;\r\n  }\r\n}\r\n"]}