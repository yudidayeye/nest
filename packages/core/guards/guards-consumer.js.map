{"version":3,"file":"guards-consumer.js","sourceRoot":"D:/04-learn-font/learn-node/nest/packages/core/","sources":["guards/guards-consumer.ts"],"names":[],"mappings":";;;AAEA,oEAA4D;AAC5D,+BAAiD;AACjD,8EAAyE;AAEzE,MAAa,cAAc;IAClB,KAAK,CAAC,WAAW,CACtB,MAAqB,EACrB,IAAe,EACf,QAAoB,EACpB,QAAyC,EACzC,IAAe;QAEf,IAAI,CAAC,MAAM,IAAI,IAAA,sBAAO,EAAC,MAAM,CAAC,EAAE;YAC9B,OAAO,IAAI,CAAC;SACb;QACD,MAAM,OAAO,GAAG,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC;QAC7D,OAAO,CAAC,OAAO,CAAW,IAAI,CAAC,CAAC;QAEhC,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE;YAC1B,MAAM,MAAM,GAAG,KAAK,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;YAC1C,IAAI,MAAM,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,EAAE;gBACjC,SAAS;aACV;YACD,OAAO,KAAK,CAAC;SACd;QACD,OAAO,IAAI,CAAC;IACd,CAAC;IAEM,aAAa,CAClB,IAAe,EACf,QAAoB,EACpB,QAAyC;QAEzC,OAAO,IAAI,6CAAoB,CAC7B,IAAI,EACJ,QAAQ,CAAC,WAAkB,EAC3B,QAAQ,CACT,CAAC;IACJ,CAAC;IAEM,KAAK,CAAC,UAAU,CACrB,MAAwD;QAExD,IAAI,MAAM,YAAY,iBAAU,EAAE;YAChC,OAAO,IAAA,oBAAa,EAAC,MAAM,CAAC,CAAC;SAC9B;QACD,OAAO,MAAM,CAAC;IAChB,CAAC;CACF;AA5CD,wCA4CC","sourcesContent":["import { CanActivate } from '@nestjs/common';\r\nimport { ContextType, Controller } from '@nestjs/common/interfaces';\r\nimport { isEmpty } from '@nestjs/common/utils/shared.utils';\r\nimport { lastValueFrom, Observable } from 'rxjs';\r\nimport { ExecutionContextHost } from '../helpers/execution-context-host';\r\n\r\nexport class GuardsConsumer {\r\n  public async tryActivate<TContext extends string = ContextType>(\r\n    guards: CanActivate[],\r\n    args: unknown[],\r\n    instance: Controller,\r\n    callback: (...args: unknown[]) => unknown,\r\n    type?: TContext,\r\n  ): Promise<boolean> {\r\n    if (!guards || isEmpty(guards)) {\r\n      return true;\r\n    }\r\n    const context = this.createContext(args, instance, callback);\r\n    context.setType<TContext>(type);\r\n\r\n    for (const guard of guards) {\r\n      const result = guard.canActivate(context);\r\n      if (await this.pickResult(result)) {\r\n        continue;\r\n      }\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public createContext(\r\n    args: unknown[],\r\n    instance: Controller,\r\n    callback: (...args: unknown[]) => unknown,\r\n  ): ExecutionContextHost {\r\n    return new ExecutionContextHost(\r\n      args,\r\n      instance.constructor as any,\r\n      callback,\r\n    );\r\n  }\r\n\r\n  public async pickResult(\r\n    result: boolean | Promise<boolean> | Observable<boolean>,\r\n  ): Promise<boolean> {\r\n    if (result instanceof Observable) {\r\n      return lastValueFrom(result);\r\n    }\r\n    return result;\r\n  }\r\n}\r\n"]}